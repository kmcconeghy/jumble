<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>jumble: Mahalanobis distance • jumble</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="jumble: Mahalanobis distance">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">jumble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-mahalanobis.html">jumble: Mahalanobis distance</a>
    </li>
    <li>
      <a href="../articles/02-rerand.html">jumble: Re-randomization approach</a>
    </li>
    <li>
      <a href="../articles/03-assignment.html">jumble: Random assignment</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kmcconeghy/jumble">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>jumble: Mahalanobis distance</h1>
                        <h4 class="author">Kevin W. McConeghy</h4>
            
            <h4 class="date">2019-06-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/kmcconeghy/jumble/blob/master/vignettes/01-mahalanobis.Rmd"><code>vignettes/01-mahalanobis.Rmd</code></a></small>
      <div class="hidden name"><code>01-mahalanobis.Rmd</code></div>

    </div>

    
    
<p>Welcome to jumble! This program was written as a companion to academic work performed by researchers at Brown University to conduct randomization procedures for cluster-randomized nursing home trials.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>In this vignette we will explain how to use Mahalanobis distance as a measure of covariate balance between two groups.</p>
<div id="example-dataset" class="section level3">
<h3 class="hasAnchor">
<a href="#example-dataset" class="anchor"></a>Example dataset</h3>
<p>The example dataset used in this package is freely available and comes from a clinical AIDs trial conducted in the 1990s.<span class="citation">(Hammer SM 1996)</span> See: ?jumble::ACTG175</p>
<div id="load-dataset" class="section level4">
<h4 class="hasAnchor">
<a href="#load-dataset" class="anchor"></a>Load dataset</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>jumble<span class="op">::</span>ACTG175

<span class="co">#Variables for balancing  </span>
var_nms &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'age'</span>, <span class="st">'race'</span>, <span class="st">'gender'</span>, <span class="st">'symptom'</span>, <span class="st">'wtkg'</span>, <span class="st">'hemo'</span>, 
          <span class="st">'msm'</span>, <span class="st">'drugs'</span>, <span class="st">'karnof'</span>, <span class="st">'oprior'</span>)</code></pre></div>
</div>
</div>
</div>
<div id="measure-of-covariate-balance" class="section level2">
<h2 class="hasAnchor">
<a href="#measure-of-covariate-balance" class="anchor"></a>Measure of covariate balance</h2>
<p>Imagine a randomized controlled trial of patients, assigned to treatment A or B. The primary goal is to have singular statistic to describe how closely ‘balanced’ individuals in group A are to group B. Morgan and Rubin describe the qualities of this statistic which are desirable.<span class="citation">(Morgan KL 2015)</span> Namely it should be ‘affinely invariant’. Which means that an affine transformation of the covariates would lead to the same re-randomization acceptance. This kind of metric will reflect the joint distribution of covariates, and provide equal balance for any linear combination of covariates. Mahalanobis distance meets these criteria.</p>
</div>
<div id="mahalanobis-distance" class="section level2">
<h2 class="hasAnchor">
<a href="#mahalanobis-distance" class="anchor"></a>Mahalanobis distance</h2>
<p>Mahalanobis or M-distance measures the distance between point P and distribution D. It is generally a measure of many standard deviations P is from the mean D.<a href="https://en.wikipedia.org/wiki/Mahalanobis_distance">full description</a></p>
<p>Mahalanobis distance can be used as a scalar measure of multivariate balance using the following formula.<span class="citation">(Morgan KL 2015)</span></p>
<p><span class="math display">\[ M \equiv \frac{n_tn_c}n (\bar{X_t} - \bar{X_c}) ' cov(X)^{-1} (\bar{X_t} - \bar{X_c}) \]</span> Where n is the sample size, t treated, c controls, and X represents the covariate means.</p>
<p>Alternatively, for stratified randomization by a distance measure, you can compute each unit’s distance from the overall group mean.</p>
<p><span class="math display">\[ M \equiv (x_i - \bar{X}) ' cov(X)^{-1} (\bar{x_i} - \bar{X}) \]</span></p>
<div id="trial-covariate-balance" class="section level3">
<h3 class="hasAnchor">
<a href="#trial-covariate-balance" class="anchor"></a>Trial Covariate Balance</h3>
<p>The ACT trial was a single randomized trial, here are the observed mean differences +/- standard deviation in that single randomization.</p>
<pre><code>##            [,1]
## age     -0.0005
## race     0.0643
## gender  -0.0506
## symptom -0.0437
## wtkg     0.0887
## hemo    -0.0126
## msm     -0.0459
## drugs   -0.0639
## karnof  -0.0177
## oprior   0.0843</code></pre>
<p>These are the standardized mean differences in selected covariates, with large treatment effects or sample sizes, small differences may not be significant, but if evaluating small effects, could be an important source of confounding.</p>
</div>
<div id="what-is-the-mahalanobis-distance-for-these-groups" class="section level3">
<h3 class="hasAnchor">
<a href="#what-is-the-mahalanobis-distance-for-these-groups" class="anchor"></a>What is the mahalanobis distance for these groups?</h3>
<p>To compute the mahalanobis formula, use must do some matrix algebra.</p>
</div>
<div id="reduce-dataset-to-needed-covariates-format" class="section level3">
<h3 class="hasAnchor">
<a href="#reduce-dataset-to-needed-covariates-format" class="anchor"></a>Reduce dataset to needed covariates, format</h3>
<ol style="list-style-type: decimal">
<li>Only include treatment indicator and k covarates<br>
</li>
<li>Ensure all covariates are numeric</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_mdist &lt;-<span class="st"> </span>df[,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'arms'</span>, var_nms)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">map_dfr</span>(., as.numeric) </code></pre></div>
</div>
<div id="sample-size-constant" class="section level3">
<h3 class="hasAnchor">
<a href="#sample-size-constant" class="anchor"></a>Sample size constant</h3>
<p><span class="math display">\[ \frac{n_tn_c}n\]</span></p>
<p>This is easy to compute</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ssc &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(df_mdist[df_mdist<span class="op">$</span>arms<span class="op">==</span><span class="dv">0</span>, ]) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(df_mdist[df_mdist<span class="op">$</span>arms<span class="op">==</span><span class="dv">1</span>, ])) <span class="op">/</span><span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(df_mdist))</code></pre></div>
<pre><code>## Sample size constant:  263.476</code></pre>
</div>
<div id="covariate-means" class="section level3">
<h3 class="hasAnchor">
<a href="#covariate-means" class="anchor"></a>Covariate means</h3>
<p><span class="math display">\[ \bar{X_t} - \bar{X_c}\]</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">X_t &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(df_mdist[df_mdist<span class="op">$</span>arms<span class="op">==</span><span class="dv">0</span>, var_nms])

X_c &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(df_mdist[df_mdist<span class="op">$</span>arms<span class="op">==</span><span class="dv">1</span>, var_nms])

X_delta &lt;-<span class="st"> </span>X_t <span class="op">-</span><span class="st"> </span>X_c </code></pre></div>
<pre><code>## Difference in covariate means by treatment: 
##   -0.004 0.029 -0.019 -0.017 1.191 -0.003 -0.022 -0.021 -0.104 0.013</code></pre>
</div>
<div id="inverse-of-covariance-of-covariate-matrix" class="section level3">
<h3 class="hasAnchor">
<a href="#inverse-of-covariance-of-covariate-matrix" class="anchor"></a>Inverse of covariance of covariate matrix</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_cov &lt;-<span class="st"> </span>df_mdist <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>arms) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cov</a></span>(.) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/solve">solve</a></span>(.) <span class="co"># inverse</span>

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(df_cov, <span class="dv">1</span>)</code></pre></div>
<pre><code>##         age race gender symptom wtkg hemo  msm drugs karnof oprior
## age     0.0  0.0    0.0     0.0  0.0  0.1  0.0   0.0    0.0    0.0
## race    0.0  5.9    0.0     0.2  0.0  2.6  2.3   0.1    0.0   -0.9
## gender  0.0  0.0   14.9     0.0 -0.1 -9.1 -9.2  -0.9    0.0   -1.1
## symptom 0.0  0.2    0.0     7.1  0.0  0.2 -0.6  -0.2    0.0   -0.4
## wtkg    0.0  0.0   -0.1     0.0  0.0  0.0  0.0   0.0    0.0    0.0
## hemo    0.1  2.6   -9.1     0.2  0.0 24.0 10.5   3.0    0.0   -0.8
## msm     0.0  2.3   -9.2    -0.6  0.0 10.5 12.5   2.9    0.0    0.2
## drugs   0.0  0.1   -0.9    -0.2  0.0  3.0  2.9  10.0    0.0    0.9
## karnof  0.0  0.0    0.0     0.0  0.0  0.0  0.0   0.0    0.0    0.1
## oprior  0.0 -0.9   -1.1    -0.4  0.0 -0.8  0.2   0.9    0.1   43.8</code></pre>
</div>
<div id="bring-formula-together" class="section level3">
<h3 class="hasAnchor">
<a href="#bring-formula-together" class="anchor"></a>Bring formula together</h3>
<p><span class="math display">\[ M \equiv \frac{n_tn_c}n (\bar{X_t} - \bar{X_c}) ' cov(X)^{-1} (\bar{X_t} - \bar{X_c}) \]</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">M_man =<span class="st"> </span>ssc <span class="op">*</span><span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(X_delta) <span class="op">%*%</span><span class="st"> </span>(df_cov <span class="op">%*%</span><span class="st"> </span>X_delta)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">as.vector</a></span>(.)</code></pre></div>
<pre><code>## Manually computed M-distance:  8.542155</code></pre>
<p>jumble package function <code>mdis_grps</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">M_jumb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mdis_grps.html">mdis_grps</a></span>(df_mdist[df_mdist<span class="op">$</span>arms<span class="op">==</span><span class="dv">0</span>, <span class="dv">2</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(df_mdist)], 
          df_mdist[df_mdist<span class="op">$</span>arms<span class="op">==</span><span class="dv">1</span>, <span class="dv">2</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(df_mdist)]) <span class="op">*</span><span class="st"> </span>ssc </code></pre></div>
<pre><code>## Jumble M-distance:  8.542155</code></pre>
<p>There is also an R-function which can compute M-distance.</p>
<pre><code>## Base R Mahalanobis:  8.542155</code></pre>
<p>There is also an Rfast function using C++:</p>
<pre><code>## Rfast Mahalanobis:  8.542155</code></pre>
<p>Manual calculation same as Base, same as Rfast</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all.equal">all.equal</a></span>(M_man, M_jumb, M_base, M_fast) <span class="co"># Nearly equal</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>All functions provide nearly equal answers.</p>
<pre><code>## Unit: microseconds
##    expr      min        lq       mean   median       uq      max neval
##  jumble 1136.690 1241.4740 1490.71560 1305.485 1605.367 6893.798  1000
##   rbase  109.899  122.4670  147.11825  134.743  161.341  292.284  1000
##   rfast   14.030   20.4605   31.43449   28.059   40.774  118.667  1000</code></pre>
<p>Rfast blows away competition!</p>
<p>Typically you would take the square root of this distance, but that is not necessary for our purposes.</p>
<p>When performing a stratified analysis, M-distance can be used to construct the strata and perform a permuted block randomization.</p>
<p>In this case, you are evaluating each person / unit’s distance from the mean of the whole group, then doing a stratified randomization by groups of like distance. Note: M-distance is an absolute measure, so does not pair those with similar covariates, but rather the joint distribution of covariates is similarly different from the mean values. So a distant value could mean covariates in the upper or lower quartile.</p>
<p>The formula is now:</p>
<p><span class="math display">\[ M \equiv ({X_i} - \bar{X}) ' cov(X)^{-1} ({X_i} - \bar{X}) \]</span></p>
<p>Test all methods give equal answers:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all.equal">all.equal</a></span>(M_man, M_base, M_fast) <span class="co"># Nearly equal</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>All functions provide nearly equal answers.</p>
</div>
<div id="benchmarking" class="section level3">
<h3 class="hasAnchor">
<a href="#benchmarking" class="anchor"></a>Benchmarking</h3>
<p>Because a limitation of re-randomization is computation time, it is important to have a function which can compute M-distance quickly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(microbenchmark)
<span class="kw">microbenchmark</span>(
  <span class="dt">mine =</span> <span class="kw"><a href="../reference/mdis_chrt.html">mdis_chrt</a></span>(tst),
  <span class="dt">rfast =</span> Rfast<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/Rfast/topics/mahala">mahala</a></span>(tst, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(tst), <span class="dt">sigma=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cov</a></span>(tst)),
  <span class="dt">rbase =</span> {<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/mahalanobis">mahalanobis</a></span>(tst, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colMeans</a></span>(tst), <span class="dt">cov=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cov</a></span>(tst))},
  <span class="dt">times =</span> <span class="dv">1000</span>
)</code></pre></div>
<pre><code>## Unit: microseconds
##   expr      min       lq       mean   median        uq       max neval
##   mine 7314.102 7946.311 11931.8839 8843.329 13428.819 87730.057  1000
##  rfast  234.412  251.949   318.1535  293.599   360.678   840.316  1000
##  rbase  385.522  417.381   536.7105  519.388   603.273  1274.064  1000</code></pre>
<p>My handwritten code is very in-efficient, Rfast outperforms the base code.<br>
In the re-randomization procedures, the R-fast computation is used for speed. Unit testing is in place to ensure the Mahalanobis calculations are consistent across Rfast, Base R and the manual computations for version control and reproducibility.</p>
</div>
</div>
<div id="contacting-authors" class="section level1">
<h1 class="hasAnchor">
<a href="#contacting-authors" class="anchor"></a>Contacting authors</h1>
<p>The primary author of the package was Kevin W. McConeghy. <a href="https://github.com/kmcconeghy/">See here</a></p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-HammerSM1996">
<p>Hammer SM, et al. 1996. “A Trial Comparing Nucleoside Monotherapy with Combination Therapy in Hiv-Infected Adults with Cd4 Cell Counts from 200 to 500 Per Cubic Millimeter.” <em>N Eng J M</em> 335: 1081–90.</p>
</div>
<div id="ref-MorganKL2015">
<p>Morgan KL, Rubin DB. 2015. “Rerandomization to Balance Tiers of Covariates.” <em>J Am Stat Assoc</em> 110 (512): 1412–21.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#measure-of-covariate-balance">Measure of covariate balance</a></li>
      <li><a href="#mahalanobis-distance">Mahalanobis distance</a></li>
      <li><a href="#contacting-authors">Contacting authors</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Kevin W. McConeghy.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
