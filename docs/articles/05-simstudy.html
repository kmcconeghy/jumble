<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>jumble: Simulation Study Code â€¢ jumble</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="jumble: Simulation Study Code">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">jumble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-mahalanobis.html">jumble: Mahalanobis distance</a>
    </li>
    <li>
      <a href="../articles/02-rerand.html">jumble: Re-randomization approach</a>
    </li>
    <li>
      <a href="../articles/03-assignment.html">jumble: Random assignment</a>
    </li>
    <li>
      <a href="../articles/04-stratification.html">jumble: Stratified Randomization</a>
    </li>
    <li>
      <a href="../articles/05-simstudy.html">jumble: Simulation Study Code</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kmcconeghy/jumble">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>jumble: Simulation Study Code</h1>
                        <h4 class="author">Kevin W. McConeghy</h4>
            
            <h4 class="date">2020-01-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/kmcconeghy/jumble/blob/master/vignettes/05-simstudy.Rmd"><code>vignettes/05-simstudy.Rmd</code></a></small>
      <div class="hidden name"><code>05-simstudy.Rmd</code></div>

    </div>

    
    
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co">#clear</span></a>
<a class="sourceLine" id="cb1-2" title="2">  knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">warning =</span> F, <span class="dt">message =</span> F)</a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">'P:</span><span class="ch">\\</span><span class="st">flunm</span><span class="ch">\\</span><span class="st">K1M</span><span class="ch">\\</span><span class="st">flublok_pretrial</span><span class="ch">\\</span><span class="st">flublok_pretrial_cfg.R'</span>)</a></code></pre></div>
<div id="load-cohort-file" class="section level2">
<h2 class="hasAnchor">
<a href="#load-cohort-file" class="anchor"></a>Load Cohort File</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">filepath &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(DataFiles, FileNames[[<span class="dv">1</span>, <span class="st">'1'</span>]])</a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3">df_trial &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(filepath) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">female =</span> <span class="kw">if_else</span>(mds_gender<span class="op">==</span><span class="st">'Female'</span>, 1L, 0L),</a>
<a class="sourceLine" id="cb2-5" title="5">         <span class="dt">pcthmo =</span> pcthmo <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) </a>
<a class="sourceLine" id="cb2-6" title="6">rw_title &lt;-<span class="st"> 'Base Cohort File'</span></a>
<a class="sourceLine" id="cb2-7" title="7"></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="kw">des_df</span>(df_trial, rw_title, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'bene_id_18900'</span>, <span class="st">'fac_id'</span>))</a></code></pre></div>
<p>7 Methods</p>
<ol style="list-style-type: decimal">
<li>Simple Random</li>
<li>2-strata randomization</li>
<li>Pair-matched design</li>
<li>K-means cluster, a prior covariates</li>
<li>K-means cluster, PCA</li>
<li>Re-randomization</li>
</ol>
</div>
</div>
<div id="simulation-set-up" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation-set-up" class="anchor"></a>Simulation Set-up</h1>
<div id="parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#parameters" class="anchor"></a>Parameters</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="cf">if</span> (F) {</a>
<a class="sourceLine" id="cb3-2" title="2">  n_rndms &lt;-<span class="st"> </span>100L</a>
<a class="sourceLine" id="cb3-3" title="3">  n_re_rndms &lt;-<span class="st"> </span>100L</a>
<a class="sourceLine" id="cb3-4" title="4">  n_permutes &lt;-<span class="st"> </span>10L</a>
<a class="sourceLine" id="cb3-5" title="5">  k_clust &lt;-<span class="st"> </span>30L</a>
<a class="sourceLine" id="cb3-6" title="6">  k_starts &lt;-<span class="st"> </span>100L</a>
<a class="sourceLine" id="cb3-7" title="7">  k_iters &lt;-<span class="st"> </span>100L</a>
<a class="sourceLine" id="cb3-8" title="8">} </a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="cf">if</span> (T) {</a>
<a class="sourceLine" id="cb3-11" title="11">  n_rndms &lt;-<span class="st"> </span>10000L</a>
<a class="sourceLine" id="cb3-12" title="12">  n_re_rndms &lt;-<span class="st"> </span>1000L</a>
<a class="sourceLine" id="cb3-13" title="13">  k_clust &lt;-<span class="st"> </span>30L</a>
<a class="sourceLine" id="cb3-14" title="14">  n_permutes &lt;-<span class="st"> </span>250L</a>
<a class="sourceLine" id="cb3-15" title="15">  k_starts &lt;-<span class="st"> </span>200000L</a>
<a class="sourceLine" id="cb3-16" title="16">  k_iters &lt;-<span class="st"> </span>100L</a>
<a class="sourceLine" id="cb3-17" title="17">}</a>
<a class="sourceLine" id="cb3-18" title="18"></a>
<a class="sourceLine" id="cb3-19" title="19">pr_reject &lt;-<span class="st"> </span><span class="fl">0.02</span>  </a>
<a class="sourceLine" id="cb3-20" title="20"></a>
<a class="sourceLine" id="cb3-21" title="21">st_seed &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="kw">ymd</span>(<span class="st">'2019-12-26'</span>))</a>
<a class="sourceLine" id="cb3-22" title="22"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(st_seed)</a>
<a class="sourceLine" id="cb3-23" title="23"></a>
<a class="sourceLine" id="cb3-24" title="24">rndm_methods &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Simple Randomizations'</span>, </a>
<a class="sourceLine" id="cb3-25" title="25">             <span class="st">'2-Strata randomization'</span>,</a>
<a class="sourceLine" id="cb3-26" title="26">             <span class="st">'Pair-matched design'</span>, </a>
<a class="sourceLine" id="cb3-27" title="27">             <span class="st">'K-means, covariates'</span>,</a>
<a class="sourceLine" id="cb3-28" title="28">             <span class="st">'K-means, PCA'</span>,</a>
<a class="sourceLine" id="cb3-29" title="29">             <span class="st">'Re-randomization'</span>)</a>
<a class="sourceLine" id="cb3-30" title="30"></a>
<a class="sourceLine" id="cb3-31" title="31"><span class="co">#unique facility list</span></a>
<a class="sourceLine" id="cb3-32" title="32">df_fac &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-33" title="33"><span class="st">    </span><span class="kw">pull</span>(fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-34" title="34"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(.) </a>
<a class="sourceLine" id="cb3-35" title="35"></a>
<a class="sourceLine" id="cb3-36" title="36"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">'Starting Seed: '</span>, st_seed, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</a>
<a class="sourceLine" id="cb3-37" title="37"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">'No. of random simulations performed: '</span>, n_rndms, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</a>
<a class="sourceLine" id="cb3-38" title="38"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">'No. of permutations performed: '</span>, n_permutes, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</a></code></pre></div>
</div>
</div>
<div id="variable-spefications" class="section level1">
<h1 class="hasAnchor">
<a href="#variable-spefications" class="anchor"></a>Variable Spefications</h1>
<div id="select-key-covariates" class="section level2">
<h2 class="hasAnchor">
<a href="#select-key-covariates" class="anchor"></a>Select key covariates</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">df_cov &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">'fac'</span>), <span class="st">"adefscore"</span>, <span class="st">'dc_hosp_any'</span>,</a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="st">"facpoor"</span>,<span class="st">"totbeds"</span>,<span class="st">"alzunit"</span>,<span class="st">"anyunit"</span> ,<span class="st">"paymcaid"</span>, <span class="st">"paymcare"</span>, <span class="st">"payother"</span>, <span class="st">"multifac"</span>, <span class="st">"profit"</span> ,<span class="st">"hospbase"</span>,<span class="st">"restrain"</span> , <span class="st">"acuindex2"</span>,</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="st">"anymdex"</span>, <span class="st">"rn2nrs"</span>, <span class="st">"dchrppd"</span>, <span class="st">"rnhrppd"</span>, <span class="st">"lpnhrppd"</span>, <span class="st">"cnahrppd"</span>, <span class="st">"adm_bed"</span>, <span class="st">"agg_cmi_2011p"</span>, <span class="st">"agglocare_2011p"</span>, <span class="st">"agg_hosp"</span>, </a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="st">"agg_comm"</span>, <span class="st">"aggadl_2011p"</span>, <span class="st">"agglowcfs"</span>, <span class="st">"aggmidcfs"</span>, <span class="st">"agghighcfs"</span>, <span class="st">"agg_female"</span>,  <span class="st">"aggblack_2011p"</span>, <span class="st">"agghisp_2011p"</span>, <span class="st">"aggwhite_2011p"</span>,</a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="st">"pcthmo"</span>, <span class="st">"agg_u65"</span>, <span class="st">"nresid"</span>, <span class="st">"avgage"</span>, <span class="st">"avgadl_2011p"</span>, <span class="st">"avgrugcmi_2011p"</span>, <span class="st">"pctlocare_2011p"</span>, <span class="st">"pctfem"</span>, </a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="st">"pctblack_2011p"</span>, <span class="st">"pcthisp_2011p"</span>, <span class="st">"pctwhite_2011p"</span>, <span class="st">"pctunder65"</span>, <span class="st">"pctlowcfs"</span>, <span class="st">"pctmidcfs"</span>, <span class="st">"pcthighcfs"</span>, <span class="st">"pctbedft_2011p"</span>, </a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="st">"pctwalking"</span>, <span class="st">"pctincont_bladr_2011p"</span>, <span class="st">"pctincont_bowel_2011p"</span>, <span class="st">"pctcath_2011p"</span>, <span class="st">"pctchf"</span>, <span class="st">"pcthyper"</span>, <span class="st">"pctschiz_bipol"</span>, </a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="st">"pctvent_2011p"</span>, <span class="st">"pctuti"</span>, <span class="st">"pctfall30_2011p"</span>,  <span class="st">"pctobese"</span>, <span class="st">"pctrxdep_2011p"</span>, <span class="st">"pctrxpsych_2011p"</span>,  <span class="st">"pctrxpsyoff_2011p"</span>, <span class="st">"NHCADL_2011p"</span>, </a>
<a class="sourceLine" id="cb4-10" title="10">  <span class="st">"NHCpain_2011p"</span>, <span class="st">"NHCpu_2011p"</span>,<span class="st">"obs_rehosprate"</span>, <span class="st">"adj_rehosprate"</span>, <span class="st">"obs_successfuldc"</span>,   </a>
<a class="sourceLine" id="cb4-11" title="11">  <span class="st">"obs_medianlos"</span>, <span class="st">"mds_hospptyr"</span>, <span class="st">"nh_days"</span>, <span class="st">"mdshosps"</span>  ,   <span class="st">"avg_dailycensus"</span> ,  <span class="st">"sd_dailycensus"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="st">  </span><span class="kw">select_if</span>(<span class="op">~!</span><span class="kw"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(.))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a></code></pre></div>
<div id="lasso" class="section level3">
<h3 class="hasAnchor">
<a href="#lasso" class="anchor"></a>LASSO</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(glmnet)</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">df_las &lt;-<span class="st"> </span>df_cov <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(dc_hosp_any <span class="op">~</span><span class="st"> </span>., <span class="dt">data=</span>.) </a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">cv_fit &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(df_las[, <span class="dv">-1</span>], df_cov<span class="op">$</span>dc_hosp_any, <span class="dt">family=</span><span class="st">'binomial'</span>, <span class="dt">alpha=</span><span class="dv">1</span>, <span class="dt">nfold =</span> <span class="dv">10</span>)</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(cv_fit)</a></code></pre></div>
</div>
<div id="covariates-from-lasso" class="section level3">
<h3 class="hasAnchor">
<a href="#covariates-from-lasso" class="anchor"></a>Covariates from LASSO</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">final.vars &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(cv_fit, <span class="dt">s =</span> <span class="st">"lambda.min"</span>)[, <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3">final.vars &lt;-<span class="st"> </span>final.vars[final.vars<span class="op">!=</span><span class="dv">0</span>]</a>
<a class="sourceLine" id="cb7-4" title="4">final.vars &lt;-<span class="st"> </span>final.vars[<span class="dv">2</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(final.vars)] <span class="op">%&gt;%</span><span class="st"> </span><span class="co">#remove intercept  </span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(.)</a>
<a class="sourceLine" id="cb7-6" title="6"></a>
<a class="sourceLine" id="cb7-7" title="7">final.vars &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(final.vars)</a>
<a class="sourceLine" id="cb7-8" title="8"></a>
<a class="sourceLine" id="cb7-9" title="9">final.vars</a></code></pre></div>
<p>mdshosps / mds_hospptyr / fac_hosp_num are all very similar so just lept mds_hospptyr.</p>
<pre><code>## Variables selected from 2015 analysis and LASSO:  pcthmo agghighcfs obs_rehosprate acuindex2 mds_hospptyr fac_ls fac_age_85 fac_white fac_black fac_diet fac_dem</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">chk_id_vars &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'age_at_indx'</span>, <span class="st">'age_65'</span>, <span class="st">'age_85'</span>, <span class="st">'female'</span>, </a>
<a class="sourceLine" id="cb9-2" title="2">                 <span class="st">'white'</span>, <span class="st">'black'</span>, <span class="st">'hispanic'</span>, <span class="st">'asian'</span>, </a>
<a class="sourceLine" id="cb9-3" title="3">                 <span class="st">'m3_adl'</span>, <span class="st">'m3_CFS'</span>, <span class="st">'m3_charlson'</span>, <span class="st">'mds_resp'</span>, </a>
<a class="sourceLine" id="cb9-4" title="4">                 <span class="st">'pcthmo'</span>, <span class="st">'agghighcfs'</span>, <span class="st">'obs_rehosprate'</span>, <span class="st">'acuindex2'</span>, <span class="st">'mds_hospptyr'</span>, </a>
<a class="sourceLine" id="cb9-5" title="5">                 <span class="st">'fac_ls'</span>, <span class="st">'M3K0510C2'</span>, <span class="st">'mds_dem'</span>, <span class="st">'dc_hosp_any'</span>,</a>
<a class="sourceLine" id="cb9-6" title="6">                 <span class="st">'M3B0100'</span>, <span class="st">'paymcaid'</span>, <span class="st">'rn2nrs'</span>, <span class="st">'facpoor'</span>)</a>
<a class="sourceLine" id="cb9-7" title="7">chk_id_lbls &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Age at index'</span>, <span class="st">'Age &gt;=65 years'</span>, <span class="st">'Age &gt;=85 years*'</span>, <span class="st">'Female*'</span>, </a>
<a class="sourceLine" id="cb9-8" title="8">                 <span class="st">'White'</span>, <span class="st">'Black'</span> ,<span class="st">'Hispanic*'</span>, <span class="st">'Asian*'</span>, </a>
<a class="sourceLine" id="cb9-9" title="9">                 <span class="st">'ADL score*'</span>, <span class="st">'CFS score*'</span>, <span class="st">'Charlson score*'</span>, <span class="st">'Resp. diagnosis'</span>, </a>
<a class="sourceLine" id="cb9-10" title="10">                 <span class="st">'Facility % HMO'</span>, <span class="st">'Agg. High CFS'</span>, <span class="st">'Obs. Rehosp. rate'</span>, <span class="st">' Acuity index'</span>,</a>
<a class="sourceLine" id="cb9-11" title="11">                 <span class="st">'MDS hosp. pt yr'</span>, <span class="st">'Facility Long-stay census'</span>, <span class="st">'Mech. Diet'</span>, <span class="st">'Dementia diagnosis'</span>, <span class="st">'Hosp. in season'</span>,</a>
<a class="sourceLine" id="cb9-12" title="12">                 <span class="st">'Comatose'</span>, <span class="st">'% Fac Medicaid'</span>, <span class="st">'RN ratio'</span>, <span class="st">'Poor resource facility'</span>)</a>
<a class="sourceLine" id="cb9-13" title="13"></a>
<a class="sourceLine" id="cb9-14" title="14"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">'Key individual or facility variables reported in checking balance: '</span>, chk_id_vars , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co">#Only for proportional variables, continuous measures dont have a percentage point diff</span></a>
<a class="sourceLine" id="cb10-2" title="2">pr_vars &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'female'</span>, <span class="st">'white'</span>, <span class="st">'black'</span>, <span class="st">'hispanic'</span>, <span class="st">'asian'</span>, <span class="st">'mds_resp'</span>,</a>
<a class="sourceLine" id="cb10-3" title="3">             <span class="st">'mds_dem'</span>, <span class="st">'M3K0510C2'</span>, <span class="st">'age_65'</span>, <span class="st">'age_85'</span>)</a>
<a class="sourceLine" id="cb10-4" title="4">pr_var_lbls &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Female*'</span>, <span class="st">'White'</span>, <span class="st">'Black'</span> ,<span class="st">'Hispanic*'</span>, <span class="st">'Asian*'</span>,</a>
<a class="sourceLine" id="cb10-5" title="5">                 <span class="st">'Resp. diagnosis'</span>, <span class="st">'Dementia diagnosis'</span>, <span class="st">'Mech. Diet'</span>, </a>
<a class="sourceLine" id="cb10-6" title="6">                 <span class="st">'Age &gt;=65 years'</span>, <span class="st">'Age &gt;=85 years*'</span>)</a>
<a class="sourceLine" id="cb10-7" title="7"></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">'Outlier definition, difference in standardized group means:'</span>, pr_reject, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</a>
<a class="sourceLine" id="cb10-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">'Variables to test for outliers:'</span>, <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(pr_vars, <span class="dt">collapse=</span><span class="st">', '</span>), <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</a></code></pre></div>
</div>
</div>
<div id="principal-components" class="section level2">
<h2 class="hasAnchor">
<a href="#principal-components" class="anchor"></a>Principal components</h2>
<div id="scale-covariates" class="section level3">
<h3 class="hasAnchor">
<a href="#scale-covariates" class="anchor"></a>Scale covariates</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">df_prcomp &lt;-<span class="st"> </span>df_cov <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>dc_hosp_any) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="st">  </span><span class="kw">distinct</span>(.) </a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5">df_prcomp_scl &lt;-<span class="st"> </span>df_prcomp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="st">  </span><span class="kw">map_dfr</span>(., scale) </a>
<a class="sourceLine" id="cb11-8" title="8"></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(df_prcomp_scl)</a></code></pre></div>
</div>
<div id="compute-pc" class="section level3">
<h3 class="hasAnchor">
<a href="#compute-pc" class="anchor"></a>Compute PC</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">pca_result &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span>(df_prcomp_scl, <span class="dt">scale =</span> <span class="ot">TRUE</span>)  </a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(pca_result)</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">e_values &lt;-<span class="st"> </span>pca_result<span class="op">$</span>sdev[pca_result<span class="op">$</span>sdev<span class="op">&gt;</span><span class="dv">1</span>] </a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="co"># First for principal components</span></a>
<a class="sourceLine" id="cb13-4" title="4">df_decomp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(pca_result<span class="op">$</span>x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="st">  </span><span class="kw">bind_cols</span>(., df_prcomp) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="st">  </span><span class="kw">select</span>(<span class="st">'fac_id'</span>, <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'PC'</span>, <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(e_values), <span class="dt">sep=</span><span class="st">''</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="op">-</span><span class="st">'fac_id'</span>), scale)</a>
<a class="sourceLine" id="cb13-8" title="8"></a>
<a class="sourceLine" id="cb13-9" title="9"></a>
<a class="sourceLine" id="cb13-10" title="10">df_pca_weighted &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(<span class="dt">fac_id=</span>df_decomp<span class="op">$</span>fac_id, </a>
<a class="sourceLine" id="cb13-11" title="11">                             <span class="dt">x2=</span><span class="kw"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(df_decomp[, <span class="dv">2</span><span class="op">:</span><span class="dv">21</span>], <span class="dv">2</span>, e_values, <span class="st">"*"</span>)) </a></code></pre></div>
</div>
</div>
</div>
<div id="functions-for-randomization" class="section level1">
<h1 class="hasAnchor">
<a href="#functions-for-randomization" class="anchor"></a>Functions for randomization</h1>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">pr_badrand &lt;-<span class="st"> </span><span class="cf">function</span>(x, cutoff, n) (<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(x)<span class="op">&gt;=</span>cutoff)<span class="op">/</span>n)<span class="op">*</span><span class="dv">100</span></a>
<a class="sourceLine" id="cb14-2" title="2"></a>
<a class="sourceLine" id="cb14-3" title="3">do_rand &lt;-<span class="st"> </span><span class="cf">function</span>(iter_df) {</a>
<a class="sourceLine" id="cb14-4" title="4">   t_diff &lt;-<span class="st"> </span>iter_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="st">      </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="st">      </span><span class="kw">summarize_all</span>(mean, <span class="dt">na.rm=</span>T) </a>
<a class="sourceLine" id="cb14-7" title="7">    </a>
<a class="sourceLine" id="cb14-8" title="8">   <span class="co">#careful refers to global environ</span></a>
<a class="sourceLine" id="cb14-9" title="9">    t_diff &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(t_diff[t_diff<span class="op">$</span>group<span class="op">==</span><span class="st">'a'</span>, chk_id_vars] <span class="op">-</span><span class="st"> </span>t_diff[t_diff<span class="op">$</span>group<span class="op">==</span><span class="st">'b'</span>, chk_id_vars])</a>
<a class="sourceLine" id="cb14-10" title="10">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(t_diff)</a>
<a class="sourceLine" id="cb14-11" title="11">}</a></code></pre></div>
</div>
<div id="method-1--simple-randomization" class="section level1">
<h1 class="hasAnchor">
<a href="#method-1--simple-randomization" class="anchor"></a>Method 1. Simple Randomization</h1>
<div id="assign-randomizations" class="section level2">
<h2 class="hasAnchor">
<a href="#assign-randomizations" class="anchor"></a>Assign randomizations</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb15-2" title="2"></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="co">## Random Assignment - Simple  </span></a>
<a class="sourceLine" id="cb15-4" title="4"></a>
<a class="sourceLine" id="cb15-5" title="5">df_m1 &lt;-<span class="st"> </span>df_cov <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="st">  </span><span class="kw">select</span>(fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="st">  </span><span class="kw">distinct</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="st">  </span><span class="kw">pull</span>(.)</a>
<a class="sourceLine" id="cb15-9" title="9"></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="co">#Matrix of values  </span></a>
<a class="sourceLine" id="cb15-11" title="11">m1_res &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb15-12" title="12"></a>
<a class="sourceLine" id="cb15-13" title="13">m1_res<span class="op">$</span>delta &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> n_rndms, <span class="dt">ncol =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-14" title="14"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(.)</a>
<a class="sourceLine" id="cb15-15" title="15"></a>
<a class="sourceLine" id="cb15-16" title="16">m1_res<span class="op">$</span>stdev &lt;-<span class="st"> </span>df_trial[, chk_id_vars] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-17" title="17"><span class="st">    </span><span class="kw">map_dfr</span>(., sd, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-18" title="18"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(.)</a>
<a class="sourceLine" id="cb15-19" title="19"></a>
<a class="sourceLine" id="cb15-20" title="20">do_it &lt;-<span class="st"> </span><span class="cf">function</span>(x)  {</a>
<a class="sourceLine" id="cb15-21" title="21">  sim_iter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_allot.html">rnd_allot</a></span>(df_m1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-22" title="22"><span class="st">      </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-23" title="23"><span class="st">      </span><span class="kw">inner_join</span>(df_trial[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, chk_id_vars)], ., <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-24" title="24"><span class="st">      </span><span class="kw">select</span>(<span class="op">-</span>fac_id)</a>
<a class="sourceLine" id="cb15-25" title="25">  </a>
<a class="sourceLine" id="cb15-26" title="26">  delta &lt;-<span class="st"> </span><span class="kw">do_rand</span>(sim_iter)</a>
<a class="sourceLine" id="cb15-27" title="27">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(delta)</a>
<a class="sourceLine" id="cb15-28" title="28">}</a>
<a class="sourceLine" id="cb15-29" title="29"></a>
<a class="sourceLine" id="cb15-30" title="30">m1_res<span class="op">$</span>delta[1L<span class="op">:</span>n_rndms, ] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(1L<span class="op">:</span>n_rndms, do_it))</a>
<a class="sourceLine" id="cb15-31" title="31">m1_res<span class="op">$</span>smd &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(m1_res<span class="op">$</span>delta[, <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars)], <span class="dv">1</span>, <span class="cf">function</span>(x) x <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(m1_res<span class="op">$</span>stdev)))</a>
<a class="sourceLine" id="cb15-32" title="32"></a>
<a class="sourceLine" id="cb15-33" title="33">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb15-34" title="34"></a>
<a class="sourceLine" id="cb15-35" title="35"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(n_rndms), <span class="st">'Randomizations for M1. Simple Random Assignment </span><span class="ch">\n</span><span class="st"> '</span>)</a>
<a class="sourceLine" id="cb15-36" title="36">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
</div>
<div id="permute-m1" class="section level2">
<h2 class="hasAnchor">
<a href="#permute-m1" class="anchor"></a>Permute M1</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(nloptr)</a>
<a class="sourceLine" id="cb16-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lme4)</a>
<a class="sourceLine" id="cb16-5" title="5"></a>
<a class="sourceLine" id="cb16-6" title="6">m1_rtest &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="dt">mode =</span> <span class="st">'double'</span>, <span class="dt">length =</span> n_permutes)</a>
<a class="sourceLine" id="cb16-7" title="7"></a>
<a class="sourceLine" id="cb16-8" title="8"><span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_permutes) {</a>
<a class="sourceLine" id="cb16-9" title="9">  facs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_allot.html">rnd_allot</a></span>(df_m1)</a>
<a class="sourceLine" id="cb16-10" title="10"></a>
<a class="sourceLine" id="cb16-11" title="11">  sim_<span class="dv">1</span> &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-12" title="12"><span class="st">    </span><span class="kw">select</span>(fac_id, dc_hosp_any) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-13" title="13"><span class="st">    </span><span class="kw">inner_join</span>(., facs, <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-14" title="14"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">assign =</span> <span class="kw">if_else</span>(group<span class="op">==</span><span class="st">'a'</span>, 1L, 0L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-15" title="15"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a>
<a class="sourceLine" id="cb16-16" title="16">  </a>
<a class="sourceLine" id="cb16-17" title="17">  iter &lt;-<span class="st"> </span><span class="kw">glmer</span>(dc_hosp_any <span class="op">~</span><span class="st"> </span>assign <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>fac_id), <span class="dt">data =</span> sim_<span class="dv">1</span>, </a>
<a class="sourceLine" id="cb16-18" title="18">                      <span class="dt">nAGQ=</span><span class="dv">0</span>, <span class="dt">control=</span><span class="kw">glmerControl</span>(<span class="dt">optimizer =</span> <span class="st">"nloptwrap"</span>), </a>
<a class="sourceLine" id="cb16-19" title="19">                      <span class="dt">family =</span> <span class="st">'binomial'</span>)</a>
<a class="sourceLine" id="cb16-20" title="20">  </a>
<a class="sourceLine" id="cb16-21" title="21">  m1_rtest[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(iter)<span class="op">$</span>fac_id[[<span class="st">'assign'</span>]])</a>
<a class="sourceLine" id="cb16-22" title="22">}</a>
<a class="sourceLine" id="cb16-23" title="23"></a>
<a class="sourceLine" id="cb16-24" title="24"></a>
<a class="sourceLine" id="cb16-25" title="25">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb16-26" title="26">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save.image</a></span>(<span class="dt">file=</span><span class="st">'flublok_pretrial_sims.RData'</span>)</a></code></pre></div>
</div>
</div>
<div id="method-2--simple-stratified-randomization---race-size" class="section level1">
<h1 class="hasAnchor">
<a href="#method-2--simple-stratified-randomization---race-size" class="anchor"></a>Method 2. Simple stratified randomization - Race, Size</h1>
<div id="assign-randomizations-1" class="section level2">
<h2 class="hasAnchor">
<a href="#assign-randomizations-1" class="anchor"></a>Assign Randomizations</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb18-2" title="2"></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="co">## 2 Stratum  </span></a>
<a class="sourceLine" id="cb18-4" title="4">  df_m2 &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="st">    </span><span class="kw">distinct</span>(fac_id, fac_black, fac_ls) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">cat_aa =</span> <span class="kw">ntile</span>(fac_black, <span class="dv">5</span>),</a>
<a class="sourceLine" id="cb18-7" title="7">           <span class="dt">cat_fs =</span> <span class="kw">ntile</span>(fac_ls, <span class="dv">5</span>),</a>
<a class="sourceLine" id="cb18-8" title="8">           <span class="dt">strata =</span> <span class="kw"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span>(cat_aa, cat_fs)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="st">    </span><span class="kw">distinct</span>(fac_id, cat_aa, cat_fs, strata)   </a>
<a class="sourceLine" id="cb18-10" title="10"></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="co">#Matrix of values  </span></a>
<a class="sourceLine" id="cb18-12" title="12">m2_res &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb18-13" title="13"></a>
<a class="sourceLine" id="cb18-14" title="14">m2_res<span class="op">$</span>delta &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> n_rndms, <span class="dt">ncol =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars))  </a>
<a class="sourceLine" id="cb18-15" title="15">m2_res<span class="op">$</span>stdev &lt;-<span class="st"> </span>df_trial[, chk_id_vars] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-16" title="16"><span class="st">    </span><span class="kw">map_dfr</span>(., sd, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-17" title="17"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(.)</a>
<a class="sourceLine" id="cb18-18" title="18"></a>
<a class="sourceLine" id="cb18-19" title="19">do_it &lt;-<span class="st"> </span><span class="cf">function</span>(x)  {</a>
<a class="sourceLine" id="cb18-20" title="20">  sim_iter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_str.html">rnd_str</a></span>(df_m2, strata, fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-21" title="21"><span class="st">    </span><span class="kw">inner_join</span>(df_trial[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, chk_id_vars)], ., <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-22" title="22"><span class="st">    </span><span class="kw">select</span>(group, chk_id_vars)</a>
<a class="sourceLine" id="cb18-23" title="23">  </a>
<a class="sourceLine" id="cb18-24" title="24">  delta &lt;-<span class="st"> </span><span class="kw">do_rand</span>(sim_iter)</a>
<a class="sourceLine" id="cb18-25" title="25">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(delta)</a>
<a class="sourceLine" id="cb18-26" title="26">}</a>
<a class="sourceLine" id="cb18-27" title="27"></a>
<a class="sourceLine" id="cb18-28" title="28">m2_res<span class="op">$</span>delta[<span class="dv">1</span><span class="op">:</span>n_rndms, ] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(1L<span class="op">:</span>n_rndms, do_it))</a>
<a class="sourceLine" id="cb18-29" title="29">m2_res<span class="op">$</span>smd &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(m2_res<span class="op">$</span>delta, <span class="dv">1</span>, <span class="cf">function</span>(x) x <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(m2_res<span class="op">$</span>stdev)))</a>
<a class="sourceLine" id="cb18-30" title="30"></a>
<a class="sourceLine" id="cb18-31" title="31">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb18-32" title="32"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(n_rndms), <span class="st">'Randomizations for M2. Stratified randomization, facility %AA and size quintiles </span><span class="ch">\n</span><span class="st"> '</span>)</a>
<a class="sourceLine" id="cb18-33" title="33">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
</div>
<div id="permute-m2" class="section level2">
<h2 class="hasAnchor">
<a href="#permute-m2" class="anchor"></a>Permute M2</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb19-2" title="2"></a>
<a class="sourceLine" id="cb19-3" title="3">m2_rtest &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="dt">mode =</span> <span class="st">'double'</span>, <span class="dt">length =</span> n_permutes)</a>
<a class="sourceLine" id="cb19-4" title="4"></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_permutes) {</a>
<a class="sourceLine" id="cb19-6" title="6">  </a>
<a class="sourceLine" id="cb19-7" title="7">  facs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_str.html">rnd_str</a></span>(df_m2, strata, fac_id)</a>
<a class="sourceLine" id="cb19-8" title="8"></a>
<a class="sourceLine" id="cb19-9" title="9">  sim_<span class="dv">1</span> &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-10" title="10"><span class="st">    </span><span class="kw">select</span>(fac_id, dc_hosp_any) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="st">    </span><span class="kw">inner_join</span>(., df_m2, <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="st">    </span><span class="kw">inner_join</span>(., facs, <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-13" title="13"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">assign =</span> <span class="kw">if_else</span>(group<span class="op">==</span><span class="st">'a'</span>, 1L, 0L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-14" title="14"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a>
<a class="sourceLine" id="cb19-15" title="15">  </a>
<a class="sourceLine" id="cb19-16" title="16">  iter &lt;-<span class="st"> </span>lme4<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(dc_hosp_any <span class="op">~</span><span class="st"> </span>assign <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(cat_aa) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(cat_fs) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>fac_id), </a>
<a class="sourceLine" id="cb19-17" title="17">              <span class="dt">nAGQ=</span><span class="dv">0</span>, <span class="dt">control=</span><span class="kw">glmerControl</span>(<span class="dt">optimizer =</span> <span class="st">"nloptwrap"</span>), </a>
<a class="sourceLine" id="cb19-18" title="18">              <span class="dt">data =</span> sim_<span class="dv">1</span>, <span class="dt">family =</span> <span class="st">'binomial'</span>)</a>
<a class="sourceLine" id="cb19-19" title="19">  </a>
<a class="sourceLine" id="cb19-20" title="20">  m2_rtest[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(iter)<span class="op">$</span>fac_id[[<span class="st">'assign'</span>]])</a>
<a class="sourceLine" id="cb19-21" title="21">}</a>
<a class="sourceLine" id="cb19-22" title="22"></a>
<a class="sourceLine" id="cb19-23" title="23"></a>
<a class="sourceLine" id="cb19-24" title="24">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb19-25" title="25">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save.image</a></span>(<span class="dt">file=</span><span class="st">'flublok_pretrial_sims.RData'</span>)</a></code></pre></div>
</div>
</div>
<div id="method-3--pair-matched-randomization---mahalanobis-distance" class="section level1">
<h1 class="hasAnchor">
<a href="#method-3--pair-matched-randomization---mahalanobis-distance" class="anchor"></a>Method 3. Pair-matched Randomization - Mahalanobis Distance</h1>
<div id="create-pair-matches" class="section level2">
<h2 class="hasAnchor">
<a href="#create-pair-matches" class="anchor"></a>Create Pair-Matches</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(nbpMatching)</a>
<a class="sourceLine" id="cb21-2" title="2"></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="co"># create a covariate matrix</span></a>
<a class="sourceLine" id="cb21-4" title="4">  df_mtch &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="st">    </span><span class="kw">select</span>(fac_id, fac_key_vars) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="st">    </span><span class="kw">distinct</span>(.)</a>
<a class="sourceLine" id="cb21-8" title="8"></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="co"># create distances</span></a>
<a class="sourceLine" id="cb21-10" title="10">  df_dist &lt;-<span class="st"> </span><span class="kw">gendistance</span>(df_mtch, <span class="dt">idcol=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb21-11" title="11"></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="co"># create distancematrix object</span></a>
<a class="sourceLine" id="cb21-13" title="13">  df_mdm &lt;-<span class="st"> </span><span class="kw">distancematrix</span>(df_dist)</a>
<a class="sourceLine" id="cb21-14" title="14"></a>
<a class="sourceLine" id="cb21-15" title="15"><span class="co"># create matches</span></a>
<a class="sourceLine" id="cb21-16" title="16">  df_mtch_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">nonbimatch</span>(df_mdm)</a>
<a class="sourceLine" id="cb21-17" title="17"></a>
<a class="sourceLine" id="cb21-18" title="18"><span class="co"># review quality of matches</span></a>
<a class="sourceLine" id="cb21-19" title="19">  df_qom &lt;-<span class="st"> </span><span class="kw">qom</span>(df_dist<span class="op">$</span>cov, df_mtch_<span class="dv">2</span><span class="op">$</span>matches)</a>
<a class="sourceLine" id="cb21-20" title="20"></a>
<a class="sourceLine" id="cb21-21" title="21">  df_mtch_<span class="dv">3</span> &lt;-<span class="st"> </span>df_mtch_<span class="dv">2</span><span class="op">$</span>matches <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-22" title="22"><span class="st">    </span><span class="kw">select</span>(Group1.ID, Group2.ID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-23" title="23"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">class =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-24" title="24"><span class="st">    </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(, <span class="dt">cols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Group1.ID'</span>, <span class="st">'Group2.ID'</span>),</a>
<a class="sourceLine" id="cb21-25" title="25">                        <span class="dt">values_to =</span> <span class="st">'fac_id'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-26" title="26"><span class="st">    </span><span class="kw">select</span>(fac_id, class) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-27" title="27"><span class="st">    </span><span class="kw">arrange</span>(fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-28" title="28"><span class="st">    </span><span class="kw">group_by</span>(fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-29" title="29"><span class="st">      </span><span class="kw">slice</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-30" title="30"><span class="st">    </span><span class="kw">ungroup</span>(.)</a>
<a class="sourceLine" id="cb21-31" title="31">    </a>
<a class="sourceLine" id="cb21-32" title="32"><span class="co">## Mahalanobis distane</span></a>
<a class="sourceLine" id="cb21-33" title="33">  df_m3 &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-34" title="34"><span class="st">    </span><span class="kw">select</span>(fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-35" title="35"><span class="st">    </span><span class="kw">inner_join</span>(., df_mtch_<span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-36" title="36"><span class="st">    </span><span class="kw">distinct</span>(.)</a>
<a class="sourceLine" id="cb21-37" title="37"></a>
<a class="sourceLine" id="cb21-38" title="38">  <span class="kw">n_distinct</span>(df_mtch_<span class="dv">3</span><span class="op">$</span>fac_id)</a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb22-2" title="2"></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="co">#Matrix of values  </span></a>
<a class="sourceLine" id="cb22-4" title="4">m3_res &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb22-5" title="5"></a>
<a class="sourceLine" id="cb22-6" title="6">m3_res<span class="op">$</span>delta &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> n_rndms, <span class="dt">ncol =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars))  </a>
<a class="sourceLine" id="cb22-7" title="7">m3_res<span class="op">$</span>stdev &lt;-<span class="st"> </span>df_trial[, chk_id_vars] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="st">    </span><span class="kw">map_dfr</span>(., sd, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-9" title="9"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(.)</a>
<a class="sourceLine" id="cb22-10" title="10"></a>
<a class="sourceLine" id="cb22-11" title="11">do_it &lt;-<span class="st"> </span><span class="cf">function</span>(x)  {</a>
<a class="sourceLine" id="cb22-12" title="12">  sim_iter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_str.html">rnd_str</a></span>(df_m3, class, fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-13" title="13"><span class="st">    </span><span class="kw">inner_join</span>(df_trial[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, chk_id_vars)], ., <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-14" title="14"><span class="st">    </span><span class="kw">select</span>(group, chk_id_vars)</a>
<a class="sourceLine" id="cb22-15" title="15">  </a>
<a class="sourceLine" id="cb22-16" title="16">  delta &lt;-<span class="st"> </span><span class="kw">do_rand</span>(sim_iter)</a>
<a class="sourceLine" id="cb22-17" title="17">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(delta)</a>
<a class="sourceLine" id="cb22-18" title="18">}</a>
<a class="sourceLine" id="cb22-19" title="19"></a>
<a class="sourceLine" id="cb22-20" title="20">m3_res<span class="op">$</span>delta[<span class="dv">1</span><span class="op">:</span>n_rndms, ] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(1L<span class="op">:</span>n_rndms, do_it))</a>
<a class="sourceLine" id="cb22-21" title="21">m3_res<span class="op">$</span>smd &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(m3_res<span class="op">$</span>delta, <span class="dv">1</span>, <span class="cf">function</span>(x) x <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(m3_res<span class="op">$</span>stdev)))</a>
<a class="sourceLine" id="cb22-22" title="22"></a>
<a class="sourceLine" id="cb22-23" title="23">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb22-24" title="24"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(n_rndms), <span class="st">'Randomizations for M3. Pair-Matched randomization, Key Variables </span><span class="ch">\n</span><span class="st"> '</span>)</a>
<a class="sourceLine" id="cb22-25" title="25">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
</div>
<div id="permute-m3" class="section level2">
<h2 class="hasAnchor">
<a href="#permute-m3" class="anchor"></a>Permute M3</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb23-2" title="2"></a>
<a class="sourceLine" id="cb23-3" title="3">m3_rtest &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="dt">mode =</span> <span class="st">'double'</span>, <span class="dt">length =</span> n_permutes)</a>
<a class="sourceLine" id="cb23-4" title="4"></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_permutes) {</a>
<a class="sourceLine" id="cb23-6" title="6">  </a>
<a class="sourceLine" id="cb23-7" title="7">  facs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_str.html">rnd_str</a></span>(df_m3, class, fac_id)</a>
<a class="sourceLine" id="cb23-8" title="8"></a>
<a class="sourceLine" id="cb23-9" title="9">  sim_<span class="dv">1</span> &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-10" title="10"><span class="st">    </span><span class="kw">select</span>(fac_id, dc_hosp_any) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-11" title="11"><span class="st">    </span><span class="kw">inner_join</span>(., facs, <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-12" title="12"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">assign =</span> <span class="kw">if_else</span>(group<span class="op">==</span><span class="st">'a'</span>, 1L, 0L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-13" title="13"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a>
<a class="sourceLine" id="cb23-14" title="14">  </a>
<a class="sourceLine" id="cb23-15" title="15">  iter &lt;-<span class="st"> </span>lme4<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(dc_hosp_any <span class="op">~</span><span class="st"> </span>assign <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>class) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>fac_id), </a>
<a class="sourceLine" id="cb23-16" title="16">                      <span class="dt">nAGQ=</span><span class="dv">0</span>, <span class="dt">control=</span><span class="kw">glmerControl</span>(<span class="dt">optimizer =</span> <span class="st">"nloptwrap"</span>), </a>
<a class="sourceLine" id="cb23-17" title="17">                      <span class="dt">data =</span> sim_<span class="dv">1</span>, <span class="dt">family =</span> <span class="st">'binomial'</span>)</a>
<a class="sourceLine" id="cb23-18" title="18">  </a>
<a class="sourceLine" id="cb23-19" title="19">  m3_rtest[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(iter)<span class="op">$</span>fac_id[[<span class="st">'assign'</span>]])</a>
<a class="sourceLine" id="cb23-20" title="20">}</a>
<a class="sourceLine" id="cb23-21" title="21"></a>
<a class="sourceLine" id="cb23-22" title="22"></a>
<a class="sourceLine" id="cb23-23" title="23">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb23-24" title="24">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save.image</a></span>(<span class="dt">file=</span><span class="st">'flublok_pretrial_sims.RData'</span>)</a></code></pre></div>
</div>
</div>
<div id="method-4--k-means-clustering-key-variables" class="section level1">
<h1 class="hasAnchor">
<a href="#method-4--k-means-clustering-key-variables" class="anchor"></a>Method 4. K-means clustering, key variables</h1>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb25-2" title="2"></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="co">#Matrix of values  </span></a>
<a class="sourceLine" id="cb25-4" title="4">df_km_<span class="dv">1</span> &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-5" title="5"><span class="st">  </span><span class="kw">select</span>(fac_id, fac_key_vars) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-6" title="6"><span class="st">  </span><span class="kw">distinct</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-7" title="7"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(fac_key_vars), scale)</a>
<a class="sourceLine" id="cb25-8" title="8"></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="cf">repeat</span> {</a>
<a class="sourceLine" id="cb25-10" title="10">  df_km_<span class="dv">2</span> &lt;-<span class="st"> </span>df_km_<span class="dv">1</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-11" title="11"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-12" title="12"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-13" title="13"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span>(<span class="dt">x=</span>., <span class="dt">centers =</span> k_clust, <span class="dt">nstart =</span> k_starts, <span class="dt">iter.max=</span>k_iters)</a>
<a class="sourceLine" id="cb25-14" title="14">  </a>
<a class="sourceLine" id="cb25-15" title="15">  df_m4 &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(<span class="dt">fac_id  =</span> df_km_<span class="dv">1</span><span class="op">$</span>fac_id,</a>
<a class="sourceLine" id="cb25-16" title="16">                         <span class="dt">strata =</span> df_km_<span class="dv">2</span><span class="op">$</span>cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-17" title="17"><span class="st">    </span><span class="kw">distinct</span>(.)</a>
<a class="sourceLine" id="cb25-18" title="18">    </a>
<a class="sourceLine" id="cb25-19" title="19">    <span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(df_m4<span class="op">$</span>strata)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb25-20" title="20">      <span class="cf">break</span></a>
<a class="sourceLine" id="cb25-21" title="21">    }</a>
<a class="sourceLine" id="cb25-22" title="22">  k_clust &lt;-<span class="st"> </span>k_clust <span class="op">+</span><span class="st"> </span>1L</a>
<a class="sourceLine" id="cb25-23" title="23">}</a>
<a class="sourceLine" id="cb25-24" title="24"></a>
<a class="sourceLine" id="cb25-25" title="25"><span class="co">#Matrix of values  </span></a>
<a class="sourceLine" id="cb25-26" title="26">m4_res &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb25-27" title="27"></a>
<a class="sourceLine" id="cb25-28" title="28">m4_res<span class="op">$</span>delta &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> n_rndms, <span class="dt">ncol =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars))  </a>
<a class="sourceLine" id="cb25-29" title="29">m4_res<span class="op">$</span>stdev &lt;-<span class="st"> </span>df_trial[, chk_id_vars] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-30" title="30"><span class="st">    </span><span class="kw">map_dfr</span>(., sd, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-31" title="31"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(.)</a>
<a class="sourceLine" id="cb25-32" title="32"></a>
<a class="sourceLine" id="cb25-33" title="33">do_it &lt;-<span class="st"> </span><span class="cf">function</span>(x)  {</a>
<a class="sourceLine" id="cb25-34" title="34"></a>
<a class="sourceLine" id="cb25-35" title="35">  sim_iter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_str.html">rnd_str</a></span>(df_m4, strata, fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-36" title="36"><span class="st">    </span><span class="kw">inner_join</span>(df_trial[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, chk_id_vars)], ., <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-37" title="37"><span class="st">    </span><span class="kw">select</span>(group, chk_id_vars)</a>
<a class="sourceLine" id="cb25-38" title="38">  </a>
<a class="sourceLine" id="cb25-39" title="39">  delta &lt;-<span class="st"> </span><span class="kw">do_rand</span>(sim_iter)</a>
<a class="sourceLine" id="cb25-40" title="40">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(delta)</a>
<a class="sourceLine" id="cb25-41" title="41">}</a>
<a class="sourceLine" id="cb25-42" title="42"></a>
<a class="sourceLine" id="cb25-43" title="43">m4_res<span class="op">$</span>delta[<span class="dv">1</span><span class="op">:</span>n_rndms, ] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="dv">1</span><span class="op">:</span>n_rndms, do_it))</a>
<a class="sourceLine" id="cb25-44" title="44">m4_res<span class="op">$</span>smd &lt;-<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(m4_res<span class="op">$</span>delta, <span class="dv">1</span>, <span class="cf">function</span>(x) x <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(m4_res<span class="op">$</span>stdev)))</a>
<a class="sourceLine" id="cb25-45" title="45"></a>
<a class="sourceLine" id="cb25-46" title="46">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb25-47" title="47"></a>
<a class="sourceLine" id="cb25-48" title="48"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(n_rndms), <span class="st">'Method 4. K-means clustering on key variables </span><span class="ch">\n</span><span class="st">'</span>)</a>
<a class="sourceLine" id="cb25-49" title="49">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
<div id="permute-m4" class="section level2">
<h2 class="hasAnchor">
<a href="#permute-m4" class="anchor"></a>Permute M4</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb26-2" title="2"></a>
<a class="sourceLine" id="cb26-3" title="3">m4_rtest &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="dt">mode =</span> <span class="st">'double'</span>, <span class="dt">length =</span> n_permutes)</a>
<a class="sourceLine" id="cb26-4" title="4"></a>
<a class="sourceLine" id="cb26-5" title="5"><span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_permutes) {</a>
<a class="sourceLine" id="cb26-6" title="6">  </a>
<a class="sourceLine" id="cb26-7" title="7">  facs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_str.html">rnd_str</a></span>(df_m4, strata, fac_id)</a>
<a class="sourceLine" id="cb26-8" title="8"></a>
<a class="sourceLine" id="cb26-9" title="9">  sim_<span class="dv">1</span> &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-10" title="10"><span class="st">    </span><span class="kw">select</span>(fac_id, dc_hosp_any) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-11" title="11"><span class="st">    </span><span class="kw">inner_join</span>(., facs, <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-12" title="12"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">assign =</span> <span class="kw">if_else</span>(group<span class="op">==</span><span class="st">'a'</span>, 1L, 0L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-13" title="13"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a>
<a class="sourceLine" id="cb26-14" title="14">  </a>
<a class="sourceLine" id="cb26-15" title="15">  iter &lt;-<span class="st"> </span>lme4<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(dc_hosp_any <span class="op">~</span><span class="st"> </span>assign <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>strata) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>fac_id), </a>
<a class="sourceLine" id="cb26-16" title="16">                      <span class="dt">nAGQ=</span><span class="dv">0</span>, <span class="dt">control=</span><span class="kw">glmerControl</span>(<span class="dt">optimizer =</span> <span class="st">"nloptwrap"</span>), </a>
<a class="sourceLine" id="cb26-17" title="17">                      <span class="dt">data =</span> sim_<span class="dv">1</span>, <span class="dt">family =</span> <span class="st">'binomial'</span>)</a>
<a class="sourceLine" id="cb26-18" title="18">  </a>
<a class="sourceLine" id="cb26-19" title="19">  m4_rtest[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(iter)<span class="op">$</span>fac_id[[<span class="st">'assign'</span>]])</a>
<a class="sourceLine" id="cb26-20" title="20">}</a>
<a class="sourceLine" id="cb26-21" title="21"></a>
<a class="sourceLine" id="cb26-22" title="22"></a>
<a class="sourceLine" id="cb26-23" title="23">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb26-24" title="24">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save.image</a></span>(<span class="dt">file=</span><span class="st">'flublok_pretrial_sims.RData'</span>)</a></code></pre></div>
</div>
</div>
<div id="method-5--k-means-pca-cluster-eigen-weighted" class="section level1">
<h1 class="hasAnchor">
<a href="#method-5--k-means-pca-cluster-eigen-weighted" class="anchor"></a>Method 5. K-means, PCA cluster eigen-weighted</h1>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb28-2" title="2"></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="co">#Matrix of values  </span></a>
<a class="sourceLine" id="cb28-4" title="4">df_pca_<span class="dv">1</span> &lt;-<span class="st"> </span>df_pca_weighted </a>
<a class="sourceLine" id="cb28-5" title="5"></a>
<a class="sourceLine" id="cb28-6" title="6"><span class="cf">repeat</span> {</a>
<a class="sourceLine" id="cb28-7" title="7">  df_km_<span class="dv">2</span> &lt;-<span class="st"> </span>df_pca_<span class="dv">1</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-8" title="8"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-9" title="9"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-10" title="10"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span>(<span class="dt">x=</span>., <span class="dt">centers =</span> k_clust, <span class="dt">nstart =</span> k_starts, <span class="dt">iter.max=</span>k_iters)</a>
<a class="sourceLine" id="cb28-11" title="11">  </a>
<a class="sourceLine" id="cb28-12" title="12">  df_m5 &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(<span class="dt">fac_id  =</span> df_pca_<span class="dv">1</span><span class="op">$</span>fac_id,</a>
<a class="sourceLine" id="cb28-13" title="13">                         <span class="dt">strata =</span> df_km_<span class="dv">2</span><span class="op">$</span>cluster) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-14" title="14"><span class="st">    </span><span class="kw">distinct</span>(.)</a>
<a class="sourceLine" id="cb28-15" title="15">    </a>
<a class="sourceLine" id="cb28-16" title="16">    <span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(df_m5<span class="op">$</span>strata)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb28-17" title="17">      <span class="cf">break</span></a>
<a class="sourceLine" id="cb28-18" title="18">    }</a>
<a class="sourceLine" id="cb28-19" title="19">  k_clust &lt;-<span class="st"> </span>k_clust <span class="op">+</span><span class="st"> </span>1L</a>
<a class="sourceLine" id="cb28-20" title="20">}</a>
<a class="sourceLine" id="cb28-21" title="21"></a>
<a class="sourceLine" id="cb28-22" title="22"><span class="co">#Matrix of values  </span></a>
<a class="sourceLine" id="cb28-23" title="23">m5_res &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb28-24" title="24"></a>
<a class="sourceLine" id="cb28-25" title="25">m5_res<span class="op">$</span>delta &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> n_rndms, <span class="dt">ncol =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars))  </a>
<a class="sourceLine" id="cb28-26" title="26">m5_res<span class="op">$</span>stdev &lt;-<span class="st"> </span>df_trial[, chk_id_vars] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-27" title="27"><span class="st">    </span><span class="kw">map_dfr</span>(., sd, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-28" title="28"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(.)</a>
<a class="sourceLine" id="cb28-29" title="29"></a>
<a class="sourceLine" id="cb28-30" title="30">do_it &lt;-<span class="st"> </span><span class="cf">function</span>(x)  {</a>
<a class="sourceLine" id="cb28-31" title="31"></a>
<a class="sourceLine" id="cb28-32" title="32">  sim_iter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_str.html">rnd_str</a></span>(df_m5, strata, fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-33" title="33"><span class="st">    </span><span class="kw">inner_join</span>(df_trial[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, chk_id_vars)], ., <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-34" title="34"><span class="st">    </span><span class="kw">select</span>(group, chk_id_vars)</a>
<a class="sourceLine" id="cb28-35" title="35">  </a>
<a class="sourceLine" id="cb28-36" title="36">  delta &lt;-<span class="st"> </span><span class="kw">do_rand</span>(sim_iter)</a>
<a class="sourceLine" id="cb28-37" title="37">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(delta)</a>
<a class="sourceLine" id="cb28-38" title="38">}</a>
<a class="sourceLine" id="cb28-39" title="39"></a>
<a class="sourceLine" id="cb28-40" title="40">m5_res<span class="op">$</span>delta[<span class="dv">1</span><span class="op">:</span>n_rndms, ] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="dv">1</span><span class="op">:</span>n_rndms, do_it))</a>
<a class="sourceLine" id="cb28-41" title="41">m5_res<span class="op">$</span>smd &lt;-<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(m5_res<span class="op">$</span>delta, <span class="dv">1</span>, <span class="cf">function</span>(x) x <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(m5_res<span class="op">$</span>stdev)))</a>
<a class="sourceLine" id="cb28-42" title="42"></a>
<a class="sourceLine" id="cb28-43" title="43">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb28-44" title="44"></a>
<a class="sourceLine" id="cb28-45" title="45"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(n_rndms), <span class="st">'Method 5. K-means on PCA </span><span class="ch">\n</span><span class="st">'</span>)</a>
<a class="sourceLine" id="cb28-46" title="46">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
<div id="permute-m5" class="section level2">
<h2 class="hasAnchor">
<a href="#permute-m5" class="anchor"></a>Permute M5</h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb29-2" title="2"></a>
<a class="sourceLine" id="cb29-3" title="3">m5_rtest &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="dt">mode =</span> <span class="st">'double'</span>, <span class="dt">length =</span> n_permutes)</a>
<a class="sourceLine" id="cb29-4" title="4"></a>
<a class="sourceLine" id="cb29-5" title="5"><span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_permutes) {</a>
<a class="sourceLine" id="cb29-6" title="6">  </a>
<a class="sourceLine" id="cb29-7" title="7">  facs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_str.html">rnd_str</a></span>(df_m5, strata, fac_id)</a>
<a class="sourceLine" id="cb29-8" title="8"></a>
<a class="sourceLine" id="cb29-9" title="9">  sim_<span class="dv">1</span> &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-10" title="10"><span class="st">    </span><span class="kw">select</span>(fac_id, dc_hosp_any) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-11" title="11"><span class="st">    </span><span class="kw">inner_join</span>(., facs, <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-12" title="12"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">assign =</span> <span class="kw">if_else</span>(group<span class="op">==</span><span class="st">'a'</span>, 1L, 0L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-13" title="13"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a>
<a class="sourceLine" id="cb29-14" title="14">  </a>
<a class="sourceLine" id="cb29-15" title="15">  iter &lt;-<span class="st"> </span>lme4<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(dc_hosp_any <span class="op">~</span><span class="st"> </span>assign <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>strata) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>fac_id), </a>
<a class="sourceLine" id="cb29-16" title="16">                      <span class="dt">nAGQ=</span><span class="dv">0</span>, <span class="dt">control=</span><span class="kw">glmerControl</span>(<span class="dt">optimizer =</span> <span class="st">"nloptwrap"</span>), </a>
<a class="sourceLine" id="cb29-17" title="17">                      <span class="dt">data =</span> sim_<span class="dv">1</span>, <span class="dt">family =</span> <span class="st">'binomial'</span>)</a>
<a class="sourceLine" id="cb29-18" title="18">  </a>
<a class="sourceLine" id="cb29-19" title="19">  m5_rtest[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(iter)<span class="op">$</span>fac_id[[<span class="st">'assign'</span>]])</a>
<a class="sourceLine" id="cb29-20" title="20">}</a>
<a class="sourceLine" id="cb29-21" title="21"></a>
<a class="sourceLine" id="cb29-22" title="22"></a>
<a class="sourceLine" id="cb29-23" title="23">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb29-24" title="24">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save.image</a></span>(<span class="dt">file=</span><span class="st">'flublok_pretrial_sims.RData'</span>)</a></code></pre></div>
</div>
</div>
<div id="method-6--re-randomization" class="section level1">
<h1 class="hasAnchor">
<a href="#method-6--re-randomization" class="anchor"></a>Method 6. Re-randomization</h1>
<div id="find-acceptable-cut-off-value" class="section level2">
<h2 class="hasAnchor">
<a href="#find-acceptable-cut-off-value" class="anchor"></a>Find Acceptable Cut-Off Value</h2>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb31-2" title="2"></a>
<a class="sourceLine" id="cb31-3" title="3">  df_rerand &lt;-<span class="st"> </span>df_cov <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-4" title="4"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>dc_hosp_any) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-5" title="5"><span class="st">    </span><span class="kw">distinct</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-6" title="6"><span class="st">    </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="op">-</span>fac_id), scale)</a>
<a class="sourceLine" id="cb31-7" title="7"></a>
<a class="sourceLine" id="cb31-8" title="8"> <span class="co"># Find M-distance cutoff empirically   </span></a>
<a class="sourceLine" id="cb31-9" title="9">  do_it &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb31-10" title="10"></a>
<a class="sourceLine" id="cb31-11" title="11">    sim_iter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_allot.html">rnd_allot</a></span>(df_fac) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-12" title="12"><span class="st">      </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-13" title="13"><span class="st">      </span><span class="kw">inner_join</span>(df_rerand, ., <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-14" title="14"><span class="st">      </span><span class="kw">select</span>(<span class="op">-</span>fac_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-15" title="15"><span class="st">      </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(.)</a>
<a class="sourceLine" id="cb31-16" title="16"></a>
<a class="sourceLine" id="cb31-17" title="17">    mdis_iter &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/mahalanobis.html">mahalanobis</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(sim_iter[sim_iter<span class="op">$</span>group<span class="op">==</span><span class="st">'a'</span>, fac_key_vars], <span class="dt">na.rm=</span>T), </a>
<a class="sourceLine" id="cb31-18" title="18">                               <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(sim_iter[sim_iter<span class="op">$</span>group<span class="op">==</span><span class="st">'b'</span>, fac_key_vars], <span class="dt">na.rm=</span>T), </a>
<a class="sourceLine" id="cb31-19" title="19">                                  <span class="dt">cov=</span> <span class="kw"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span>(sim_iter[, fac_key_vars])) <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-20" title="20"><span class="st">                   </span>((<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(sim_iter[sim_iter<span class="op">$</span>group<span class="op">==</span><span class="st">'a'</span>, ]) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(sim_iter[sim_iter<span class="op">$</span>group<span class="op">==</span><span class="st">'b'</span>, ])) <span class="op">/</span><span class="st"> </span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(sim_iter)))</a>
<a class="sourceLine" id="cb31-21" title="21">  }</a>
<a class="sourceLine" id="cb31-22" title="22"></a>
<a class="sourceLine" id="cb31-23" title="23">  m6_chk_mdis &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="dv">1</span><span class="op">:</span>n_rndms, do_it)</a>
<a class="sourceLine" id="cb31-24" title="24">  </a>
<a class="sourceLine" id="cb31-25" title="25">  m6_cutoff &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(m6_chk_mdis, <span class="fl">0.001</span>)  </a>
<a class="sourceLine" id="cb31-26" title="26">  </a>
<a class="sourceLine" id="cb31-27" title="27">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb31-28" title="28"></a>
<a class="sourceLine" id="cb31-29" title="29"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">'Method 6. Re-randomization cut-off'</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(m6_cutoff, <span class="dv">3</span>), <span class="st">' </span><span class="ch">\n</span><span class="st">'</span>)</a>
<a class="sourceLine" id="cb31-30" title="30">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
</div>
<div id="perform-re-randomizations" class="section level2">
<h2 class="hasAnchor">
<a href="#perform-re-randomizations" class="anchor"></a>Perform Re-randomizations</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb32-2" title="2"></a>
<a class="sourceLine" id="cb32-3" title="3">  m6_res &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb32-4" title="4">  </a>
<a class="sourceLine" id="cb32-5" title="5">  m6_res<span class="op">$</span>delta &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> n_re_rndms, <span class="dt">ncol =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars))  </a>
<a class="sourceLine" id="cb32-6" title="6">  m6_res<span class="op">$</span>stdev &lt;-<span class="st"> </span>df_trial[, chk_id_vars] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-7" title="7"><span class="st">      </span><span class="kw">map_dfr</span>(., sd, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-8" title="8"><span class="st">      </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(.)</a>
<a class="sourceLine" id="cb32-9" title="9"></a>
<a class="sourceLine" id="cb32-10" title="10">  df_m6 &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-11" title="11"><span class="st">    </span><span class="kw">select</span>(fac_id, fac_key_vars) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-12" title="12"><span class="st">    </span><span class="kw">distinct</span>()   </a>
<a class="sourceLine" id="cb32-13" title="13">  </a>
<a class="sourceLine" id="cb32-14" title="14">  do_it &lt;-<span class="st"> </span><span class="cf">function</span>(x)  {</a>
<a class="sourceLine" id="cb32-15" title="15">    <span class="cf">repeat</span> { <span class="co"># search for good rerand</span></a>
<a class="sourceLine" id="cb32-16" title="16">    </a>
<a class="sourceLine" id="cb32-17" title="17">      chk_rand &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_allot.html">rnd_allot</a></span>(df_fac) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-18" title="18"><span class="st">        </span><span class="kw">inner_join</span>(df_m6[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, fac_key_vars)], ., <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'id'</span>)) </a>
<a class="sourceLine" id="cb32-19" title="19">    </a>
<a class="sourceLine" id="cb32-20" title="20">      mdis_iter &lt;-<span class="st"> </span>Rfast<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/Rfast/man/mahala.html">mahala</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(chk_rand[chk_rand<span class="op">$</span>group<span class="op">==</span><span class="st">'a'</span>, fac_key_vars], <span class="dt">na.rm=</span>T), </a>
<a class="sourceLine" id="cb32-21" title="21">                                 <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(chk_rand[chk_rand<span class="op">$</span>group<span class="op">==</span><span class="st">'b'</span>, fac_key_vars], <span class="dt">na.rm=</span>T), </a>
<a class="sourceLine" id="cb32-22" title="22">                                 <span class="dt">sigma=</span> <span class="kw"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span>(chk_rand[, fac_key_vars])) <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-23" title="23"><span class="st">                       </span>((<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(chk_rand[chk_rand<span class="op">$</span>group<span class="op">==</span><span class="st">'a'</span>, ]) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(chk_rand[chk_rand<span class="op">$</span>group<span class="op">==</span><span class="st">'b'</span>, ])) <span class="op">/</span><span class="st"> </span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(chk_rand)))</a>
<a class="sourceLine" id="cb32-24" title="24">      </a>
<a class="sourceLine" id="cb32-25" title="25">      <span class="cf">if</span>(mdis_iter<span class="op">&lt;</span>m6_cutoff) {</a>
<a class="sourceLine" id="cb32-26" title="26">        <span class="cf">break</span></a>
<a class="sourceLine" id="cb32-27" title="27">      }</a>
<a class="sourceLine" id="cb32-28" title="28">    }</a>
<a class="sourceLine" id="cb32-29" title="29">  </a>
<a class="sourceLine" id="cb32-30" title="30">  sim_iter &lt;-<span class="st"> </span><span class="kw">inner_join</span>(df_trial[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, chk_id_vars)], </a>
<a class="sourceLine" id="cb32-31" title="31">                         chk_rand[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, <span class="st">'group'</span>)], </a>
<a class="sourceLine" id="cb32-32" title="32">                         <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-33" title="33"><span class="st">    </span><span class="kw">select</span>(group, chk_id_vars)</a>
<a class="sourceLine" id="cb32-34" title="34">  </a>
<a class="sourceLine" id="cb32-35" title="35">  delta &lt;-<span class="st"> </span><span class="kw">do_rand</span>(sim_iter)</a>
<a class="sourceLine" id="cb32-36" title="36">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(delta)</a>
<a class="sourceLine" id="cb32-37" title="37">}</a>
<a class="sourceLine" id="cb32-38" title="38"></a>
<a class="sourceLine" id="cb32-39" title="39">m6_res<span class="op">$</span>delta[<span class="dv">1</span><span class="op">:</span>n_rndms, ] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(1L<span class="op">:</span>n_rndms, do_it))</a>
<a class="sourceLine" id="cb32-40" title="40">m6_res<span class="op">$</span>smd &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(m6_res<span class="op">$</span>delta, <span class="dv">1</span>, <span class="cf">function</span>(x) x <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(m6_res<span class="op">$</span>stdev)))</a>
<a class="sourceLine" id="cb32-41" title="41"></a>
<a class="sourceLine" id="cb32-42" title="42">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb32-43" title="43"></a>
<a class="sourceLine" id="cb32-44" title="44"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(n_rndms), <span class="st">'Method 6. Re-randomizations, </span><span class="ch">\n</span><span class="st">'</span>)</a>
<a class="sourceLine" id="cb32-45" title="45">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
</div>
<div id="permute-m6" class="section level2">
<h2 class="hasAnchor">
<a href="#permute-m6" class="anchor"></a>Permute M6</h2>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">st_run &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb33-2" title="2"></a>
<a class="sourceLine" id="cb33-3" title="3">m6_rtest &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="dt">mode =</span> <span class="st">'double'</span>, <span class="dt">length =</span> n_permutes)</a>
<a class="sourceLine" id="cb33-4" title="4"></a>
<a class="sourceLine" id="cb33-5" title="5"><span class="cf">for</span> (i  <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_permutes) {</a>
<a class="sourceLine" id="cb33-6" title="6">  </a>
<a class="sourceLine" id="cb33-7" title="7">      <span class="cf">repeat</span> { <span class="co"># search for good rerand</span></a>
<a class="sourceLine" id="cb33-8" title="8">    </a>
<a class="sourceLine" id="cb33-9" title="9">      chk_rand &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rnd_allot.html">rnd_allot</a></span>(df_fac) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-10" title="10"><span class="st">        </span><span class="kw">inner_join</span>(df_m6[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, fac_key_vars)], ., <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>=<span class="st">'id'</span>)) </a>
<a class="sourceLine" id="cb33-11" title="11">    </a>
<a class="sourceLine" id="cb33-12" title="12">      mdis_iter &lt;-<span class="st"> </span>Rfast<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/Rfast/man/mahala.html">mahala</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(chk_rand[chk_rand<span class="op">$</span>group<span class="op">==</span><span class="st">'a'</span>, fac_key_vars], <span class="dt">na.rm=</span>T), </a>
<a class="sourceLine" id="cb33-13" title="13">                                 <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(chk_rand[chk_rand<span class="op">$</span>group<span class="op">==</span><span class="st">'b'</span>, fac_key_vars], <span class="dt">na.rm=</span>T), </a>
<a class="sourceLine" id="cb33-14" title="14">                                 <span class="dt">sigma=</span> <span class="kw"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span>(chk_rand[, fac_key_vars])) <span class="op">*</span><span class="st"> </span></a>
<a class="sourceLine" id="cb33-15" title="15"><span class="st">                       </span>((<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(chk_rand[chk_rand<span class="op">$</span>group<span class="op">==</span><span class="st">'a'</span>, ]) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(chk_rand[chk_rand<span class="op">$</span>group<span class="op">==</span><span class="st">'b'</span>, ])) <span class="op">/</span><span class="st"> </span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(chk_rand)))</a>
<a class="sourceLine" id="cb33-16" title="16">      </a>
<a class="sourceLine" id="cb33-17" title="17">      <span class="cf">if</span>(mdis_iter<span class="op">&lt;</span>m6_cutoff) {</a>
<a class="sourceLine" id="cb33-18" title="18">        <span class="cf">break</span></a>
<a class="sourceLine" id="cb33-19" title="19">      }</a>
<a class="sourceLine" id="cb33-20" title="20">    }</a>
<a class="sourceLine" id="cb33-21" title="21">  </a>
<a class="sourceLine" id="cb33-22" title="22">  sim_<span class="dv">1</span> &lt;-<span class="st"> </span>df_trial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-23" title="23"><span class="st">    </span><span class="kw">select</span>(fac_id, dc_hosp_any) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-24" title="24"><span class="st">    </span><span class="kw">inner_join</span>(., chk_rand[, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>, <span class="st">'group'</span>)], <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'fac_id'</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-25" title="25"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">assign =</span> <span class="kw">if_else</span>(group<span class="op">==</span><span class="st">'a'</span>, 1L, 0L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-26" title="26"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a>
<a class="sourceLine" id="cb33-27" title="27">  </a>
<a class="sourceLine" id="cb33-28" title="28">  </a>
<a class="sourceLine" id="cb33-29" title="29">  iter &lt;-<span class="st"> </span>lme4<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(dc_hosp_any <span class="op">~</span><span class="st"> </span>assign <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>fac_id), </a>
<a class="sourceLine" id="cb33-30" title="30">                      <span class="dt">nAGQ=</span><span class="dv">0</span>, <span class="dt">control=</span><span class="kw">glmerControl</span>(<span class="dt">optimizer =</span> <span class="st">"nloptwrap"</span>), </a>
<a class="sourceLine" id="cb33-31" title="31">                      <span class="dt">data =</span> sim_<span class="dv">1</span>, <span class="dt">family =</span> <span class="st">'binomial'</span>)</a>
<a class="sourceLine" id="cb33-32" title="32">  </a>
<a class="sourceLine" id="cb33-33" title="33">  m6_rtest[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(iter)<span class="op">$</span>fac_id[[<span class="st">'assign'</span>]])</a>
<a class="sourceLine" id="cb33-34" title="34">}</a>
<a class="sourceLine" id="cb33-35" title="35"></a>
<a class="sourceLine" id="cb33-36" title="36"></a>
<a class="sourceLine" id="cb33-37" title="37">st_end &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb33-38" title="38">st_end <span class="op">-</span><span class="st"> </span>st_run</a></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save.image</a></span>(<span class="dt">file=</span><span class="st">'flublok_pretrial_sims.RData'</span>)</a></code></pre></div>
</div>
</div>
<div id="evaluation-of-methods" class="section level1">
<h1 class="hasAnchor">
<a href="#evaluation-of-methods" class="anchor"></a>Evaluation of Methods</h1>
<div id="distribution-of-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#distribution-of-variables" class="anchor"></a>Distribution of Variables</h2>
</div>
<div id="gather-checking-variables-from-methods" class="section level2">
<h2 class="hasAnchor">
<a href="#gather-checking-variables-from-methods" class="anchor"></a>Gather checking variables from Methods</h2>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">fct_lvls &lt;-<span class="st"> </span>rndm_methods</a>
<a class="sourceLine" id="cb35-2" title="2"></a>
<a class="sourceLine" id="cb35-3" title="3"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>) { <span class="co">#loop to create smd objects</span></a>
<a class="sourceLine" id="cb35-4" title="4">  <span class="kw"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'m'</span>, i, <span class="st">'_diff'</span>), <span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'m'</span>, i, <span class="st">'_res'</span>))<span class="op">$</span>delta <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-5" title="5"><span class="st">     </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-6" title="6"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Method =</span> fct_lvls[i]))</a>
<a class="sourceLine" id="cb35-7" title="7">}</a>
<a class="sourceLine" id="cb35-8" title="8"></a>
<a class="sourceLine" id="cb35-9" title="9">diff_all &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/get.html">mget</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>()[<span class="kw">str_detect</span>(<span class="kw"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>(), <span class="st">'_diff'</span>)]) <span class="co">#get all objects with '_diff' names</span></a>
<a class="sourceLine" id="cb35-10" title="10"></a>
<a class="sourceLine" id="cb35-11" title="11">diff_all &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(diff_all) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-12" title="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Method =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Method, <span class="dt">levels=</span> fct_lvls)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-13" title="13"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a>
<a class="sourceLine" id="cb35-14" title="14"></a>
<a class="sourceLine" id="cb35-15" title="15"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(diff_all) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(chk_id_vars, <span class="st">'Method'</span>)</a>
<a class="sourceLine" id="cb35-16" title="16"></a>
<a class="sourceLine" id="cb35-17" title="17">diff_all_grp &lt;-<span class="st"> </span><span class="kw">gather</span>(diff_all, <span class="dt">key =</span> <span class="st">'var'</span>, <span class="dt">value =</span> <span class="st">'x'</span>, <span class="op">-</span>Method) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-18" title="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">var =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(var, <span class="dt">levels=</span>chk_id_vars, <span class="dt">labels =</span> chk_id_lbls))</a></code></pre></div>
</div>
<div id="compute-range-of-values" class="section level2">
<h2 class="hasAnchor">
<a href="#compute-range-of-values" class="anchor"></a>Compute range of values</h2>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1">cats &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.975</span>)</a>
<a class="sourceLine" id="cb36-2" title="2"></a>
<a class="sourceLine" id="cb36-3" title="3">quant_vals &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb36-4" title="4">  y &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x, <span class="dt">probs=</span>cats)</a>
<a class="sourceLine" id="cb36-5" title="5">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(y)</a>
<a class="sourceLine" id="cb36-6" title="6">}</a></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1">cats_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(cats[<span class="dv">1</span>], <span class="dv">6</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars)), </a>
<a class="sourceLine" id="cb37-2" title="2">          <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(cats[<span class="dv">2</span>], <span class="dv">6</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars)), </a>
<a class="sourceLine" id="cb37-3" title="3">          <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(cats[<span class="dv">3</span>], <span class="dv">6</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars)), </a>
<a class="sourceLine" id="cb37-4" title="4">          <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(cats[<span class="dv">4</span>], <span class="dv">6</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars)), </a>
<a class="sourceLine" id="cb37-5" title="5">          <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(cats[<span class="dv">5</span>], <span class="dv">6</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(chk_id_vars)))</a>
<a class="sourceLine" id="cb37-6" title="6"></a>
<a class="sourceLine" id="cb37-7" title="7">sum_diff_grp &lt;-<span class="st"> </span>diff_all_grp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-8" title="8"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/split.html">split</a></span>(., <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(.<span class="op">$</span>Method, .<span class="op">$</span>var)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-9" title="9"><span class="st">  </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="op">~</span><span class="kw">quant_vals</span>(.<span class="op">$</span>x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-10" title="10"><span class="st">  </span><span class="kw">bind_rows</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-11" title="11"><span class="st">  </span><span class="kw">pivot_longer</span>(., </a>
<a class="sourceLine" id="cb37-12" title="12">               <span class="dt">cols =</span> <span class="kw">everything</span>(),</a>
<a class="sourceLine" id="cb37-13" title="13">               <span class="dt">values_to =</span> <span class="st">'x'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-14" title="14"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Quintile =</span> cats_<span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-15" title="15"><span class="st">  </span><span class="kw">separate</span>(., name, <span class="dt">into =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Method'</span>, <span class="st">'var'</span>), <span class="dt">sep =</span> <span class="st">"([</span><span class="ch">\\</span><span class="st">.])"</span>) </a></code></pre></div>
<div id="table-of-quintiles" class="section level3">
<h3 class="hasAnchor">
<a href="#table-of-quintiles" class="anchor"></a>Table of Quintiles</h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1">tab_quint &lt;-<span class="st"> </span>sum_diff_grp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-2" title="2"><span class="st">  </span><span class="kw">pivot_wider</span>(., <span class="dt">id_cols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(Method, var), <span class="dt">names_from =</span> Quintile, <span class="dt">values_from =</span> x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-3" title="3"><span class="st">  </span><span class="kw">select</span>(var, <span class="kw">everything</span>()) </a>
<a class="sourceLine" id="cb38-4" title="4"></a>
<a class="sourceLine" id="cb38-5" title="5">tab_quint[, <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(tab_quint[, <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>], <span class="dv">3</span>) </a>
<a class="sourceLine" id="cb38-6" title="6"></a>
<a class="sourceLine" id="cb38-7" title="7">DT<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span>(tab_quint)</a></code></pre></div>
</div>
<div id="variables-greater-0-2-smd" class="section level3">
<h3 class="hasAnchor">
<a href="#variables-greater-0-2-smd" class="anchor"></a>Variables greater 0.2 SMD</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1">fct_lvls &lt;-<span class="st"> </span>rndm_methods</a>
<a class="sourceLine" id="cb39-2" title="2"></a>
<a class="sourceLine" id="cb39-3" title="3"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>) { <span class="co">#loop to create smd objects</span></a>
<a class="sourceLine" id="cb39-4" title="4">  <span class="kw"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'m'</span>, i, <span class="st">'_smd'</span>), <span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'m'</span>, i, <span class="st">'_res'</span>))<span class="op">$</span>smd <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-5" title="5"><span class="st">     </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-6" title="6"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Method =</span> fct_lvls[i]))</a>
<a class="sourceLine" id="cb39-7" title="7">}</a>
<a class="sourceLine" id="cb39-8" title="8"></a>
<a class="sourceLine" id="cb39-9" title="9">smd_all &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/get.html">mget</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>()[<span class="kw">str_detect</span>(<span class="kw"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>(), <span class="st">'_smd'</span>)]) <span class="co">#get all objects with '_smd' names</span></a>
<a class="sourceLine" id="cb39-10" title="10"></a>
<a class="sourceLine" id="cb39-11" title="11">smd_all &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(smd_all) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-12" title="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Method =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Method, <span class="dt">levels=</span> fct_lvls)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-13" title="13"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(.)</a>
<a class="sourceLine" id="cb39-14" title="14"></a>
<a class="sourceLine" id="cb39-15" title="15"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(smd_all) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(chk_id_vars, <span class="st">'Method'</span>)</a>
<a class="sourceLine" id="cb39-16" title="16"></a>
<a class="sourceLine" id="cb39-17" title="17">smd_all_grp &lt;-<span class="st"> </span><span class="kw">gather</span>(smd_all, <span class="dt">key =</span> <span class="st">'var'</span>, <span class="dt">value =</span> <span class="st">'x'</span>, <span class="op">-</span>Method) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-18" title="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">var =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(var, <span class="dt">levels=</span>chk_id_vars, <span class="dt">labels =</span> chk_id_lbls))</a></code></pre></div>
<div id="table-of-variables-with-0-2-smd" class="section level4">
<h4 class="hasAnchor">
<a href="#table-of-variables-with-0-2-smd" class="anchor"></a>Table % of variables with &gt;0.2 SMD</h4>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1">prop_outlier &lt;-<span class="st"> </span>smd_all_grp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">out =</span> <span class="kw">if_else</span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(x)<span class="op">&gt;</span><span class="fl">0.2</span>, 1L, 0L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Method, var) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">pr_out =</span> (<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(out) <span class="op">/</span><span class="st"> </span><span class="kw">n</span>())<span class="op">*</span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-5" title="5"><span class="st">  </span><span class="kw">pivot_wider</span>(., <span class="dt">id_cols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(var), <span class="dt">names_from =</span> Method, <span class="dt">values_from =</span> pr_out)</a>
<a class="sourceLine" id="cb40-6" title="6"></a>
<a class="sourceLine" id="cb40-7" title="7">DT<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span>(prop_outlier)</a></code></pre></div>
</div>
</div>
<div id="variance-reduction" class="section level3">
<h3 class="hasAnchor">
<a href="#variance-reduction" class="anchor"></a>Variance reduction</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1">var_all_grp &lt;-<span class="st"> </span>diff_all_grp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Method, var) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">variance =</span> <span class="kw"><a href="https://rdrr.io/r/stats/cor.html">var</a></span>(x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-4" title="4"><span class="st">  </span><span class="kw">pivot_wider</span>(., <span class="dt">id_cols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(var), <span class="dt">names_from =</span> Method, <span class="dt">values_from =</span> variance)</a>
<a class="sourceLine" id="cb41-5" title="5"></a>
<a class="sourceLine" id="cb41-6" title="6"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>) {</a>
<a class="sourceLine" id="cb41-7" title="7">  var_all_grp[, i] &lt;-<span class="st"> </span>(var_all_grp[, i] <span class="op">-</span><span class="st"> </span>var_all_grp[, <span class="dv">2</span>]) <span class="op">/</span><span class="st"> </span>var_all_grp[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb41-8" title="8">}</a>
<a class="sourceLine" id="cb41-9" title="9"></a>
<a class="sourceLine" id="cb41-10" title="10">prvred &lt;-<span class="st"> </span>var_all_grp[, <span class="dv">-2</span>] </a>
<a class="sourceLine" id="cb41-11" title="11"></a>
<a class="sourceLine" id="cb41-12" title="12">prvred[<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(prvred)<span class="op">+</span><span class="dv">1</span>, <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(prvred[, <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>])</a>
<a class="sourceLine" id="cb41-13" title="13">prvred[<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(prvred)<span class="op">+</span><span class="dv">1</span>, <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(prvred[, <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>], min)</a>
<a class="sourceLine" id="cb41-14" title="14">prvred[<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(prvred)<span class="op">+</span><span class="dv">1</span>, <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(prvred[, <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>], max)  </a>
<a class="sourceLine" id="cb41-15" title="15"></a>
<a class="sourceLine" id="cb41-16" title="16">DT<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span>(prvred) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-17" title="17"><span class="st">  </span>DT<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DT/man/formatCurrency.html">formatRound</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2</span><span class="op">:</span><span class="dv">6</span>), <span class="dv">3</span>)</a></code></pre></div>
</div>
<div id="permutation-results" class="section level3">
<h3 class="hasAnchor">
<a href="#permutation-results" class="anchor"></a>Permutation Results</h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>) { <span class="co">#loop to create smd objects</span></a>
<a class="sourceLine" id="cb42-2" title="2">  <span class="kw"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'m'</span>, i, <span class="st">'_diff'</span>), <span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'m'</span>, i, <span class="st">'_res'</span>))<span class="op">$</span>delta <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-3" title="3"><span class="st">     </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-4" title="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Method =</span> fct_lvls[i]))</a>
<a class="sourceLine" id="cb42-5" title="5">}</a>
<a class="sourceLine" id="cb42-6" title="6"></a>
<a class="sourceLine" id="cb42-7" title="7">rtest_all &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/get.html">mget</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>()[<span class="kw">str_detect</span>(<span class="kw"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>(), <span class="st">'_rtest'</span>)]) <span class="co">#get all objects with '_smd' names</span></a>
<a class="sourceLine" id="cb42-8" title="8"></a>
<a class="sourceLine" id="cb42-9" title="9">rtest_all &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(rtest_all)</a>
<a class="sourceLine" id="cb42-10" title="10"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(rtest_all) &lt;-<span class="st"> </span>fct_lvls </a>
<a class="sourceLine" id="cb42-11" title="11"></a>
<a class="sourceLine" id="cb42-12" title="12">rtest_all_grp &lt;-<span class="st"> </span><span class="kw">pivot_longer</span>(rtest_all, <span class="dt">cols =</span> <span class="kw">everything</span>(), <span class="dt">names_to =</span> <span class="st">'Method'</span>, <span class="dt">values_to =</span> <span class="st">'x'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-13" title="13"><span class="st">  </span><span class="kw">arrange</span>(Method) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-14" title="14"><span class="st">  </span><span class="kw">group_by</span>(Method) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-15" title="15"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">lci =</span> <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x, <span class="dt">probs =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.025</span>)),</a>
<a class="sourceLine" id="cb42-16" title="16">            <span class="dt">uci =</span> <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x, <span class="dt">probs =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.975</span>)))  </a>
<a class="sourceLine" id="cb42-17" title="17"></a>
<a class="sourceLine" id="cb42-18" title="18">DT<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span>(rtest_all_grp) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-19" title="19"><span class="st">  </span>DT<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DT/man/formatCurrency.html">formatRound</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2</span><span class="op">:</span><span class="dv">6</span>), <span class="dv">4</span>)</a></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save.image</a></span>(<span class="dt">file=</span><span class="st">'flublok_pretrial_sims.RData'</span>)</a></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#setup">Setup</a><ul class="nav nav-pills nav-stacked">
<li><a href="#load-cohort-file">Load Cohort File</a></li>
      </ul>
</li>
      <li>
<a href="#simulation-set-up">Simulation Set-up</a><ul class="nav nav-pills nav-stacked">
<li><a href="#parameters">Parameters</a></li>
      </ul>
</li>
      <li>
<a href="#variable-spefications">Variable Spefications</a><ul class="nav nav-pills nav-stacked">
<li><a href="#select-key-covariates">Select key covariates</a></li>
      <li><a href="#principal-components">Principal components</a></li>
      </ul>
</li>
      <li><a href="#functions-for-randomization">Functions for randomization</a></li>
      <li>
<a href="#method-1--simple-randomization">Method 1. Simple Randomization</a><ul class="nav nav-pills nav-stacked">
<li><a href="#assign-randomizations">Assign randomizations</a></li>
      <li><a href="#permute-m1">Permute M1</a></li>
      </ul>
</li>
      <li>
<a href="#method-2--simple-stratified-randomization---race-size">Method 2. Simple stratified randomization - Race, Size</a><ul class="nav nav-pills nav-stacked">
<li><a href="#assign-randomizations-1">Assign Randomizations</a></li>
      <li><a href="#permute-m2">Permute M2</a></li>
      </ul>
</li>
      <li>
<a href="#method-3--pair-matched-randomization---mahalanobis-distance">Method 3. Pair-matched Randomization - Mahalanobis Distance</a><ul class="nav nav-pills nav-stacked">
<li><a href="#create-pair-matches">Create Pair-Matches</a></li>
      <li><a href="#permute-m3">Permute M3</a></li>
      </ul>
</li>
      <li>
<a href="#method-4--k-means-clustering-key-variables">Method 4. K-means clustering, key variables</a><ul class="nav nav-pills nav-stacked">
<li><a href="#permute-m4">Permute M4</a></li>
      </ul>
</li>
      <li>
<a href="#method-5--k-means-pca-cluster-eigen-weighted">Method 5. K-means, PCA cluster eigen-weighted</a><ul class="nav nav-pills nav-stacked">
<li><a href="#permute-m5">Permute M5</a></li>
      </ul>
</li>
      <li>
<a href="#method-6--re-randomization">Method 6. Re-randomization</a><ul class="nav nav-pills nav-stacked">
<li><a href="#find-acceptable-cut-off-value">Find Acceptable Cut-Off Value</a></li>
      <li><a href="#perform-re-randomizations">Perform Re-randomizations</a></li>
      <li><a href="#permute-m6">Permute M6</a></li>
      </ul>
</li>
      <li>
<a href="#evaluation-of-methods">Evaluation of Methods</a><ul class="nav nav-pills nav-stacked">
<li><a href="#distribution-of-variables">Distribution of Variables</a></li>
      <li><a href="#gather-checking-variables-from-methods">Gather checking variables from Methods</a></li>
      <li><a href="#compute-range-of-values">Compute range of values</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kevin W. McConeghy.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
